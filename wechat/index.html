
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <meta name="referrer" content="never">
    <title>超级通客服聊天系统</title>

    <!-- Bootstrap Core CSS -->
        <link rel="icon" href="./static/img/favicon.ico" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./static/home/css/amazeui.min.css" />
    <link rel="stylesheet" href="./static/home/css/main.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
</head>


<body>

<div class="box">
    <div class="wechat">
        <div class="wechat_list" style="right: -220px;">
            <!--三图标-->
            <div class="" id="wechatListDiv">
                loading
            </div>

        </div>


        <div class="sidestrip">
            <div class="am-dropdown" data-am-dropdown>
                <!--头像插件-->
                <div class="own_head am-dropdown-toggle">
                    <img id="selectedHeadPic" src="./static/img/defaultHeadPic.jpg" style="width: 40px;height:40px;margin-left: 10px;border-radius: 50%;">
                </div>
                <div class="am-dropdown-content" id="selectedWxData">
                    <div class="own_head_top">
                        <div class="own_head_top_text">
                            <p class="own_name"><span id="selectedWechatName">所有账号</span><i id="sexSpan" style="color:dodgerblue;" class="fa fa-male"></i></p>
                            <p class="own_numb">微信号：
                                <input type="hidden" value="loading" id="updateRemarkNameWxid">
                                <i id="selectedWechatWxid">...</i>
                            </p>
                        </div>
                        <img id="selectedWechatHead" src="./static/img/defaultHeadPic.jpg" alt="" />
                    </div>
                    <div class="own_head_bottom">
                        <p><span>地区</span><i id="selectedWechatArea">...</i></p>
                    </div>
                </div>
            </div>

            <!--三图标-->
            <div class="sidestrip_icon">
                <a id="si_msg" title="好友消息" class="fa fa-comment fa-2x selected" href="javascript:checkUserGroup('msg')"></a>
                <a id="si_mark" title="特别关注" class="fa fa-bookmark-o fa-2x" href="javascript:checkUserGroup('mark')"></a>
                <a id="si_fd" title="所有好友" style="display: none;" class="fa fa-user-o fa-2x" href="javascript:checkUserGroup('fd')"></a>

                <a id="si_room_msg" style="" title="群消息列表" class="fa fa-comments-o fa-2x" href="javascript:checkUserGroup('room_msg')"></a>
                <a id="si_room_list"  style="display: none;" title="所有群列表" class="fa fa-users fa-2x" href="javascript:checkUserGroup('room_list')"></a>


            </div>
            <div class="retract">
                <span class="retract_span"><i class="fa fa-bars fa-2x" aria-hidden="true"></i></span>
            </div>
        </div>

        <!--聊天列表-->
        <div class="middle on">
            <div class="wx_change">
                <button onclick="selectWechatFriend(0);" class="listBtn listBtn-active" id="listBtn1">
                    <span class="wx_change_span wx_change_span_active">待回复</span>
                </button>
                <button onclick="selectWechatFriend(1);" class="listBtn" id="listBtn2">
                    <span class="wx_change_span">最近联系</span>
                </button>
                <button onclick="selectTwoRead(0);" class="listBtn" id="listBtn2">
                    <span class="wx_change_span">可回复</span>
                </button>
            </div>
            <div class="wx_search" style="padding: 12px;">
                <input type="text" id="wx_search_input" placeholder="搜索"/>
                <i class="fa fa-search" style="margin-left:10px;cursor: pointer" onclick="searchLocalFriend()"></i>
            </div>
            <div class="office_text">
                <ul class="user_list" id="serviceFriendList">
                    <li>
                        未收到好友消息
                    </li>
                </ul>

            </div>
            <div>
                <a id="getMoreFriendBtn"  href="javascript:doSearchMoreFriend()">点击加载更多</a>
            </div>
        </div>

        <!--标记好友列表-->
        <div class="middle">
            <div class="wx_search" style="padding: 12px 12px 6px 12px;">
                <input type="text" id="care_input" placeholder="搜索"/>
                <i class="fa fa-search" style="margin-left:10px;cursor: pointer" onclick="searchInputCareFriend()"></i>
            </div>
            <div class="wx_search" style="padding: 6px 12px 12px 12px;">
                <select class="care-select-list" name="" id="" style="padding-left: 0">

                </select>
                <i class="fa fa-search" style="margin-left:10px;cursor: pointer" onclick="searchSelectCareFriend()"></i>
            </div>
            <div class="office_text">
                <ul class="friends_list" id="allMarkFriendList">
                    <li>
                        <p> 数据加载中... </p>
                    </li>
                </ul>
            </div>
        </div>

        <!--账号的所有好友列表 -->
        <div class="middle">
            <div class="wx_search">
                <input type="text" id="tset" placeholder="搜索"/>
                <i class="fa fa-search" style="margin-left:10px;cursor: pointer" onclick="searchLocalFriends()"></i>
            </div>
            <div class="office_text">
                <ul class="friends_list" id="allFriendList">
                    <li>
                        <p> 数据加载中... </p>
                    </li>
                </ul>
            </div>
        </div>

        <!--聊天列表-->
        <div class="middle">
            <div class="wx_change">
                <button onclick="selectTalkingRoomList(0);" class="listBtn listBtn-active" id="roomList1">
                    <span class="wx_change_span wx_change_span_active">待回复</span>
                </button>
                <button onclick="selectTalkingRoomList(1);" class="listBtn" id="roomList2">
                    <span class="wx_change_span">最近联系</span>
                </button>
            </div>
            <div class="room_search" style="padding: 12px;">
                <input type="text" id="room_search_input" placeholder="搜索"/>
                <i class="fa fa-search" style="margin-left:10px;cursor: pointer" onclick="searchWxRoom()"></i>
            </div>
            <div class="office_text">
                <ul class="user_list" id="talkingRoomList">
                    <li>
                        未收到群消息
                    </li>
                </ul>

            </div>
            <div>
                <a id="getMoreWxRoomBtn"  href="javascript:selectTalkingRoomList(0)">点击加载更多</a>
            </div>
        </div>

        <!--账号的所有好友列表 -->
        <div class="middle">
            <div class="wx_search">
                <input type="text" id="roomSearchInput" placeholder="搜索"/>
                <i class="fa fa-search" style="margin-left:10px;cursor: pointer" onclick="searchLocalRoom()"></i>
            </div>
            <div class="office_text">
                <ul class="friends_list" id="allRoomList">
                    <li>
                        <p> 数据加载中... </p>
                    </li>
                </ul>
            </div>
        </div>

        <!--聊天窗口-->
        <div class="talk_window">
            <div class="windows_top">
                <div class="windows_top_box">
                    <span  id="currentFriendName" style="font-size:8px;" ></span>
                    <ul class="window_icon">
                        <li id="">
                            <div class="dropdown">
                                <a  class="dropdown-toggle" data-toggle="dropdown"  title="在线" aria-haspopup="true" aria-expanded="true" href="javascript:;">
                                    <i class="fa fa-chevron-down"></i>
                                </a>
                                <ul class="dropdown-menu" style="height: 75px; min-width: 45px !important;padding:5px 0 0 0;">
                                    <li style="color: green; width: 100%; margin-bottom: 10px;cursor: pointer;text-align: center;" onclick="serviceOnline(1)">
                                       上线
                                    </li>
                                    <li style="color: red; width: 100%;cursor: pointer;text-align: center;" onclick="serviceOnline(0)">
                                        下线
                                    </li>
                                </ul>
                            </div>
                        </li>
                            <li id="onlineStatusLi" style="display: none;color: green;text-align: center">
                                在线
                            </li>
                            <li id="downStatusLi" class="" style="color: red;text-align: center;">
                                离线
                            </li>
                        <li  id="logoutLi"><a title="退出系统" href="javascript:logout()"><i class="fa fa-remove"></i></a></li>
                    </ul>
                    
                    <div class="extend" title="好友信息" onclick="selectFriendInfo()" class="am-btn am-btn-success" ></div>
                    <!-- 侧边栏内容 -->
                    <div id="doc-oc-demo3" class="am-offcanvas" style="z-index: -1;">
                        <div class="am-offcanvas-bar">
                            <div style="color:white;margin-left:10px;">
                                好友信息
                            </div>
                            <div style="margin: 5px 0">
                                <button class="saveFix" id="sf" onclick="updateRemarkName()">修改备注</button>
                                <button class="saveFix" id="bd">绑定标签</button>
                            </div>
                            <div class="am-offcanvas-content">
                                <table id="friendInfoTable" style="color:white;" class="friendInfoTable" >
                                    <tr>
                                        <td colspan="2" style="text-align: center;">
                                            <img id="friendInfoHead" style="width:100px;height:100px;" src= "./static/img/defaultHeadPic.jpg">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td valign="top" class="friendInfoLabel">微信号:</td>
                                        <td id="friendInfoWxid">loading</td>
                                    </tr>
                                    <tr>
                                       <td valign="top" class="friendInfoLabel">昵称:</td>
                                       <td id="friendInfoNickname">loading</td>
                                    </tr>
                                    <tr title="请尽量手动输入备注名称">
                                       <td valign="top" class="friendInfoLabel">备注:</td>
                                       <td id="friendInfoMarkName" title="可修改备注" >loading</td>
                                    </tr>
                                    <tr>
                                       <td valign="top" class="friendInfoLabel">性别:</td>
                                       <td id="friendInfoSex">loading</td>
                                    </tr>
                                    <tr>
                                       <td valign="top" class="friendInfoLabel">地区:</td>
                                        <td>
                                            <span id="friendInfoProvince">loading</span>
                                            <span id="friendInfoCity">loading</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td valign="top" class="friendInfoLabel">个性签名:</td>
                                        <td id="friendInfoSignature">loading</td>
                                    </tr>
                                    <tr>
                                        <td valign="top" class="friendInfoLabel">标签:
                                        <input type="hidden" id="labelIdsHidden" value="">
                                        </td>
                                        <td id="friendInfoTag">loading</td>
                                    </tr>
                                </table>

                                <table id="chatRoomInfoTable" style="color:white;display: none;" class="friendInfoTable" >
                                    <tr>
                                        <td colspan="2" style="text-align: center;">
                                            <img id="chatRoomHeadImg" style="width:100px;height:100px;" src= "./static/img/defaultHeadPic.jpg">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td valign="top" class="friendInfoLabel">群号:</td>
                                        <td id="chatRoomIdTd">loading</td>
                                    </tr>
                                    <tr>
                                        <td valign="top" class="friendInfoLabel">群名称:</td>
                                        <td id="chatRoomNameTd">loading</td>
                                    </tr>

                                    <tr>
                                        <td valign="top" class="friendInfoLabel">群成员数:
                                        </td>
                                        <td id="chatRoomMemCount">loading</td>
                                    </tr>
                                    <tr>
                                        <td valign="top" class="friendInfoLabel">成员列表:
                                        </td>
                                        <td id="" style="max-width: 100px;">
                                            <table id="roomMemTable" style="max-width:100px;" >
                                                <tr>
                                                    <td>loading</td>
                                                </tr>
                                            </table>

                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--聊天内容-->
            <div class="windows_body" id="msgBody">
                <div class="office_text" style="height: 100%;">
                    <ul class="content" id="chatbox">
                    </ul>
                </div>
            </div>

            <div class="windows_input" id="talkbox">
                <div class="input_icon" id="sendDiv">
                    <a  href="javascript:;" class="js-face-btn fa fa-smile-o fa-lg dropdown-toggle" data-toggle="dropdown" ondragstart="return false"></a>
                    <a class="fa fa-photo fa-lg"  style="position: relative;display: inline-block;overflow: hidden;text-decoration: none;text-indent: 0;line-height: 23px;" >
                        <input  accept="image/png,image/gif, image/jpg, image/jpeg" id="sendImgInput" onchange="inputImg(this)"   type="file" style="opacity:0;right: 0;top:0;position: absolute;" >
                    </a>
                    <a class="fa fa-volume-up fa-lg"  style="position: relative;display: inline-block;overflow: hidden;text-decoration: none;text-indent: 0;line-height: 23px;" >
                        <input  accept="audio/mpeg"  id="sendVoiceInput" onchange="inputVoice(this)" type="file" style="opacity:0;right: 0;top:0;position: absolute;" >
                    </a>
                        <input type="hidden" value="" name="fileName" id="sendFileName" >
                        <span id="careBtnDiv">
                            <a href="javascript:showCare();" class="fa fa-heart fa-lg care-un" ondragstart="return false"></a>
                            <a href="javascript:showCare();" class="fa fa-heart fa-lg care-ed" ondragstart="return false" style="color: red;display: none"></a>

                        </span>
                        <a title="发送名片" href="javascript:showSendCardDiv();" class="fa fa-plus fa-lg" ondragstart="return false"></a>
                    <a href="javascript:showQuickMsgList();" class="fa fa-file-text-o fa-lg" style="float: right;" ondragstart="return false"></a>
                    <a href="javascript:showChatRecords(0);" class="fa fa-commenting-o fa-lg" style="float: right;" ondragstart="return false"></a>
                </div>
                <div class="input_box" >
                    <div contenteditable="plaintext-only" onkeydown="keySend();" class="inputboxes" style="margin-right: 2px;overflow: auto;" id="inputBox"></div>
                    <button id="send" onclick="sender()">发送(Enter)</button>
                </div>
                <div id="quickMsgListDiv">
                    <div class="modal-content quickMsg">
                        <div class="quickMsgHead">
                            <div class="quickMsgHeadOption">
                                <button class="checkspanBtn checkspanBtn-active" onclick="selectQuickMsgPageList(1, 10, null, 0)">
                                    <span class="checkspan checkspan-active">公共</span>
                                </button>
                                <button class="checkspanBtn" onclick="selectQuickMsgPageList(1, 10, null, 1)">
                                    <span class="checkspan ">私有</span>
                                </button>
                            </div>
                            <div class="wx_search" style="padding: 5px 0; width: 200%;">
                                <input type="text" id="searchQuickMsgKeyWords" placeholder="搜索" style="width: 150px" />
                                <i class="fa fa-search" style="margin-left:10px;" onclick="selectByKeyWords()"></i>
                            </div>
                        </div>
                        <div class="quickTables">
                            <table id="quickMsgTable">
                                <tr>
                                    <td onclick="chooseQuickMsg(this)" onmouseover="showQuickMsg(this)">暂时没有相关数据</td>
                                </tr>
                            </table>
                        </div>
                        <div class="quickFoot">
                            <div class="quickFoot2">
                                <img onclick="javascript:prePage()" src="./static/img/perv.png" alt="" style="width: 20px;height: 20px;cursor: pointer">
                                <div class="turnDetail">
                                    转到<input type="number"  id="pageNoInput" min="1"  name="">页
                                    <a class="btn btn-default" onclick="goToPage()" style="padding: 3px 6px;">GO</a>
                                </div>
                                <img onclick="javascript:nextPage()" src="./static/img/next.png" alt="" style="width: 20px;height: 20px;cursor: pointer">
                            </div>
                            <div class="quickFoot1">
                                <input type="hidden" id="pageNoData" value="1">
                                <input type="hidden" id="totalRecordsData" value="1">

                                <span id="pageNoSpan">第1页</span>
                                <span id="totalRecordsSpan">共1页</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 聊天记录 -->
        <div class="chat_records">
            <div class="records_closed">
                <i class="fa fa-times fa-lg" aria-hidden="true"></i>
            </div>
            <div class="records_head">
                聊天记录
            </div>
            <div class="office_text" id="talkRecord" style="height: 558px;">
                <ul class="content" id="chatboxs">

                </ul>
            </div>
        </div>
    </div>

    <div style="display: none;">
        <audio id="audioPart" controls="controls" style="display:none;">
            <source src="" type="audio/ogg">
            <source src="" type="audio/mpeg">
           您的浏览器不支持语音播放.
        </audio>
    </div>

    <div class="hideAudio" style="display: none;">

    </div>

    <div class="care">
        <div class="care-title"></div>
        <div class="care-set">
            <div class="care-set-btn care-set-del">删除分组</div>
            <div class="care-set-btn care-set-add">添加分组</div>
        </div>
        <div class="care-content">
            <span class="care-content-desc">绑定分组:</span>
            <select class="care-select" name="" id="">

            </select>
        </div>
        <div class="care-foot">
            <div class="care-foot-btn care-foot-cancel">取消</div>
            <div class="care-foot-btn care-foot-confirm">确认</div>
        </div>
    </div>

    <div class="addCare">
        <div class="addCare-title">添加分组</div>
        <div class="addCare-content">
            <span class="addCare-content-desc">分组名称:</span>
            <input type="text" class="addCare-input" maxlength="30" placeholder="最多30字符">
        </div>
        <div class="addCare-foot">
            <div class="addCare-foot-btn addCare-foot-cancel">取消</div>
            <div class="addCare-foot-btn addCare-foot-confirm">添加</div>
        </div>
    </div>
    <div class="delCare">
        <div class="delCare-title">删除分组</div>
        <div class="delCare-content">
            <span class="delCare-content-desc">选择删除分组:</span>
            <select class="delCare-select" name="" id="">

            </select>
        </div>
        <div class="delCare-foot">
            <div class="delCare-foot-btn delCare-foot-cancel">取消</div>
            <div class="delCare-foot-btn delCare-foot-confirm">删除</div>
        </div>
    </div>
    <div class="care-mask"></div>
</div>



<!-- 图片预览 -->
<div class="quickmask"></div>
<div class="quickimgpreview">
    <img class="previewimg" src="">
</div>

<!-- 标签页面 -->
<div class="tags">
    <div class="tags_closed">
        <i class="fa fa-times fa-lg" aria-hidden="true"></i>
    </div>
    <div class="tags_head">
        所有标签
    </div>
    <div class="tags_text">

    </div>
    <div class="tags_foot">
        <button class="tags_confirm" onclick="bindFriendTag()">确定</button>
        <button class="tags_cancel">重置</button>
    </div>
</div>

<!-- 新增标签 -->
<div class="newTag">
    <div class="newTag-head">
        <span class="newTag-head-item newTag-head-item-active">文字</span>
        <span class="newTag-head-item">图片</span>
        <span class="newTag-head-item">语音</span>
        <i class="fa fa-close fa-2x newTag-btn-cancel" style="float: right;margin-right: 10px;cursor: pointer"></i>
    </div>
    <div class="newTag-content">
        <div class="newTag-content-item" data-x="0">
            <p>请输入文字内容</p>
            <textarea class="newTag-text" placeholder="请输入文字内容"></textarea>
        </div>
        <div class="newTag-content-item" data-x="1" style="display: none;">
            <input type="file" name="fileImg" accept="image/png,image/gif,image/jpeg" onchange="inputTagImg(this)">
            <div class="newTag-img-preview">

            </div>
        </div>
        <div class="newTag-content-item" data-x="2" style="display: none;">
            <input type="file" name="fileAudio" accept="audio/mpeg" onchange="inputTagImg(this)">
        </div>
    </div>
    <div class="newTag-tile">
       <label style="width:90px;text-align:center;">标题:</label>
        <input type="text" name="" id="msgRemark" style="width:435px;height:35px;" />
    </div>
    <div class="newTag-foot">
        <div class="newTag-btn newTag-btn-cancel" id="">取消</div>
        <div class="newTag-btn" id="newTag-btn-confirm">确认</div>
    </div>
</div>
<div class="newTag-mask"></div>

<div class="loadingDiv">
    <div></div>
    <div>
        <h1 class="loading" style=""><i class="fa fa-spinner fa-pulse fa-fw"></i>加载中...</h1>
    </div>
</div>



<div class="send_card_div">
    <div class="mainDiv">
        <div class="card-head" >
            <span class="">发送名片</span>
            <i class="fa fa-close fa-2x" onclick="closeCardDiv()" style="float: right;margin-right: 10px;cursor: pointer"></i>
        </div>
        <div class="card-content">

            <div class="card-tip">
                <span style="color: goldenrod;">发送名片的wxid, 必须是该选中账号的好友, 否则发送失败</span>
            </div>
            <div class="card-data">
                <label style="width:120px;text-align:center;">名片好友wxid:</label>
                <input type="text" name="" id="friendCardWxid" style="width:435px;height:35px;" />
            </div>
        </div>
        <div class="card-foot">
            <div class="newTag-btn newTag-btn-cancel" onclick="closeCardDiv()" id="">取消</div>
            <div class="newTag-btn" id="sendCardBtn" onclick="sendWxCardMsg()">确认</div>
        </div>
    </div>
</div>

</body>
<script type="text/javascript" src="./static/js/common.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script>



</script>

<script type="text/javascript" src="./static/home/js/amazeui.min.js"></script>
<script type="text/javascript" src="./static/home/js/zUI.js"></script>
<script type="text/javascript" src="./static/home/js/wechat.js"></script>
<script type="text/javascript" src="./static/home/js/qqface.wx.js"></script>
<script type="text/javascript" src="./static/home/js/moment.js"></script>

<script type="text/javascript" src="./static/js/areaData.js"></script>
<script src="./static/js/upload/lib/plupload-2.1.2/js/plupload.full.min.js"></script>


<script src="./static/js/upload/upload.js?v=1"></script>
<script src="./static/js/jquery.cookie.js"></script>

<script>
    var socket;
    var selectedWechat = null;
    var selectedFriend = null;
    var selectChatRoom = null;

    var allFriendsList = [];
    var selectedUserGroup = 'msg';
    var checkMove = false;
    var sideMove = false;
    var leftSideMove = false;
    var recordId = null;
    var selectedQuickMsgType = 0;
    var careWechatId = '';
    var careAllotId = '';
    var sendHeaderImg = '';
    var lastQueryTime = '';
    var lastQueryRoomTime = '';
    var selectedReadStatus = 0;
    var isSelectTwoRead = 0;
    var selectedRoomMemInfo = new Map();

    basePath = ''

    //查询出所有的账号

    selectWechatFriend()
    checkOnlineStatus()
    // function bindUploadForVice(contentForm, browseBtn, uploadBtn, inputBtn, perBar, doMethod) {
    // bindUpload("sendDiv", "sendImgInput",  "send", "sendFileName", "inputBox", doSendMessage)

    var heartCheck = {
        timeout: 60000,
        timeoutObj: null,
        reset: function(){
            clearTimeout(this.timeoutObj);
            this.start();
        },
        start: function(){
            this.timeoutObj = setTimeout(function(){
                socket.send("HeartBeat");
            }, this.timeout)
        }
    };


    $(function () {
        $('.js-face-btn').qqFace({
            id: 'facebox',
            assign: 'inputBox' ,
            path: './static/img',	//表情存放的路径
        });
    });


    /**
     * 客服上线/下线
     */
    function checkOnlineStatus() {
        var serviceId = 273;
        var onlineStatus = $.cookie('onlineStatus_' + serviceId);
        if(onlineStatus && onlineStatus==1) {
            connectServer();

            $("#onlineStatusLi").show();
            $("#downStatusLi").hide();
        } else {
            closeSocket();

            $("#onlineStatusLi").hide();
            $("#downStatusLi").show();
        }
    }

    function  downLine() {
        jQuery.post( "http://47.115.80.88:8082/cs/downLine",
            function (data, textStatus){
                if (data.resCode == 0) {
                    // location.href = basePath + "/homePage";
                } else {
                    alert(data.resDesc);
                }
            } , "json")
    }

    var imgFile = {};
    //上传图片
    function inputImg(doc) {

        if($(doc)[0].files[0] != null && $(doc)[0].files[0] != undefined) {
            var imgid = guid();
            imgFile.imgid = $(doc)[0].files[0];
            var freader = new FileReader();
            freader.readAsDataURL($(doc)[0].files[0]);
            freader.onload = function(e){
                $("#inputBox").append('<img data-id="'+imgid+'" class="customImg" style="max-height:200px;max-width:200px;" src="'+e.target.result+'">');
                $("#inputBox").focus();
            };
            $(doc).val("");
        }
    }

    <!--把文件转换成可读URL-->
    function getObjectURL(file) {
        var url = null;
        if (window.createObjectURL != undefined) { // basic
            url = window.createObjectURL(file);
        } else if (window.URL != undefined) { // mozilla(firefox)
            url = window.URL.createObjectURL(file);
        } else if (window.webkitURL != undefined) { // webkit or chrome
            url = window.webkitURL.createObjectURL(file);
        }
        return url;
    }

    //语音对象
    var audio = document.getElementById('audioPart');
    audio.addEventListener('ended', function () {
        //播放结束
        $(".voicePlay").removeClass("voicePlay");
    }, false);

    <!--校验并获取语音时长-->
    function checkVoice(doc, uuid, localUrl) {
        setTimeout(function () {
            var duration = audio.duration;
            if(isNaN(duration)){
                checkVoice(doc, uuid, localUrl);
            } else{
                var time = parseInt(audio.duration);
                if (time > 60) {
                    alert("语音最长为60秒");
                } else {
                    //执行发送语音操作
                    // var timeLength = time * 20;
                    // timeLength = timeLength > 240 ? 240 : timeLength;
                    // timeLength = timeLength < 30 ? 30 : timeLength;

                    showSendMsg(selectedWechat, selectedFriend, 3, 1, localUrl, uuid);
                    //显示时间
                    // $("#" + uuid).after("<i>" + time + "\'\'</i>")
                    sendVoiceMsg(doc, uuid);

                }
            }
        }, 10);
    }



    //发送语音
    function sendVoiceMsg(doc, uuid) {
        var sourceFile = $(doc)[0].files[0];
        var formData = new FormData();
        formData.append('msgFile', sourceFile);
        formData.append("wxid", selectedWechat);
        formData.append("targetWxid", selectedFriend);
        formData.append("msgType", 3);

        //见发送内容传到后台
        $.ajax({
            url: basePath + "http://47.115.80.88:8082/cs/sendMSgWithFile",
            type: "post",
            data: formData,
            contentType: false,
            processData: false,
            mimeType: "multipart/form-data",
            success: function (data) {
                $(doc).val("");
                data = $.parseJSON(data);
                if (data.resCode == "0") {
                    //发送成功
                    $("#" + uuid).hide();
                } else {
                    $("#" + uuid).removeClass("fa-spinner fa-pulse");
                    $("#" + uuid).addClass("fa-info-circle fa-rotate-180");
                    document.getElementById(uuid).style.color="red";
                    console.log(data.resDesc);
                }
            },
            error: function (data) {
                $("#" + uuid).removeClass("fa-spinner fa-pulse");
                $("#" + uuid).addClass("fa-info-circle fa-rotate-180");
                document.getElementById(uuid).style.color="red";
            }
        });


    }


    //上传语音
    function inputVoice(doc) {
        if($(doc)[0].files[0] != null && $(doc)[0].files[0] != undefined) {
            var uuid = guid();
            var sourceFile = $(doc)[0].files[0];
            var localUrl = getObjectURL(sourceFile);
            $("#audioPart").attr("src", localUrl);
            checkVoice(doc, uuid, localUrl);
        }
    }



    //播放语音
    function playVoice(doc, url) {
        // var audio = document.getElementById('audioPart');
        var flag = audio.paused;
        $("#audioPart").attr("src", url);
        if (flag) {
            audio.play();//播放
            $(".voicePlay").removeClass("voicePlay");
            $(doc).find(".voiceBg").addClass("voicePlay");
        } else {
            audio.pause();// 这个就是暂停
            $(".voicePlay").removeClass("voicePlay");
        }

    }

    //客服上线
    function serviceOnline(status) {
        if (status == 0) {
            downLine();
        }
        var serviceId = 273;
        $.cookie('onlineStatus_' + serviceId, status, { expires: 7, path: '/' });
        checkOnlineStatus();
    }

    //连接socket
    function connectServer() {
        var connetcUrl = "ws://47.115.80.88:18083/ws";
        if (!window.WebSocket) {
            window.WebSocket = window.MozWebSocket;
        }
        if (window.WebSocket) {
            if (socket == null || socket == undefined) {
                socket = new WebSocket(connetcUrl);
            } else {
                if (socket.readyState != WebSocket.OPEN) {
                    socket = new WebSocket(connetcUrl);
                }
            }
            socket.onmessage = function(event) {
                heartCheck.reset();
                // $("#msgBody").append(event.data);
                //TODO 需要解析收到的内容

                var msgContent = event.data;

                console.log("收到消息" +msgContent);
                var jsonObj = JSON.parse(msgContent);
                var wxid = jsonObj.wxid;
                var targetWxid = jsonObj.targetWxid;
                var targetType = jsonObj.targetType;
                var msgType = jsonObj.msgType;
                var msg = jsonObj.msgContent;
                var sendWxid = jsonObj.sendWxid;


                var recordId = jsonObj.recordId;
                if (wxid == selectedWechat && targetWxid == selectedFriend && targetType == 2) {

                    showSendMsg(wxid, targetWxid, msgType, targetType, msg,null,  recordId, sendWxid);

                    readFriendMsg(wxid, targetWxid);

                } else {
                    if (targetType == 2) {
                        if (targetWxid.indexOf("@chatroom") != -1) {
                            var targetClassName = targetWxid.replace("@chatroom", "_chatroom");
                            var roomText = $("#" + wxid + targetClassName).text();
                            var fnum = 1;
                            if (roomText) {
                                fnum = $("#" + wxid + targetClassName + " .msgNums").html();
                                fnum = parseInt(fnum) + 1;
                                $("#" + wxid + targetClassName + " .msgNums").html(fnum);
                                $("#" + wxid + targetClassName + " .msgNums").show();
                            }
                            //查询好友信息
                            jQuery.post( "http://47.115.80.88:8082/cs/selectChatRoomInfo", {"wxid": wxid, "wxRoomId": targetWxid},
                                    function (data, textStatus){
                                        if (data.resCode == 0) {
                                            if(data.data == null || data.data.roomName == null || data.data.roomName == "") {
                                                jQuery.post( "http://47.115.80.88:8082/cs/freshContactDetail", {"wxid": wxid, "targetWxid": targetWxid},
                                                        function (data, textStatus){
                                                            if (data.resCode == 0) {

                                                                showPushRoomInfo(data.data.nickname, wxid, targetWxid, fnum, data.data.bigHeadPic);
                                                            } else {
                                                                console.log(data.resDesc);
                                                            }
                                                        } , "json");
                                            } else {
                                                showPushRoomInfo(data.data.roomName, wxid, targetWxid, fnum, data.data.smallHeadPic);
                                            }

                                        } else {
                                            console.log(data.resDesc);
                                        }
                                    } , "json");

                        } else {

                            var nums = $("#wechat_" + wxid + " .msgNums").html();
                            $("#wechat_" + wxid + " .msgNums").html(parseInt(nums)+1);
                            $("#wechat_" + wxid + " .msgNums").show();
                            // selectAllWechat(wxid);
                            var targetClassName = targetWxid.replace("@openim", "_openim");
                            var friendText = $("#" + wxid + targetClassName).text();
                            var fnum = 1;
                            if (friendText) {
                                fnum = $("#" + wxid + targetWxid + " .msgNums").html();
                                fnum = parseInt(fnum) + 1;
                                $("#" + wxid + targetWxid + " .msgNums").html(fnum);
                                $("#" + wxid + targetWxid + " .msgNums").show();
                            }
                            //查询好友信息
                            jQuery.post( "http://47.115.80.88:8082/cs/selectFriendInfo", {"wxid": wxid, "targetWxid": targetWxid},
                                    function (data, textStatus){
                                        if (data.resCode == 0) {
                                            if(data.data == null || data.data.nickname == null || data.data.nickname == "") {
                                                jQuery.post( "http://47.115.80.88:8082/cs/freshContactDetail", {"wxid": wxid, "targetWxid": targetWxid},
                                                        function (data, textStatus){
                                                            if (data.resCode == 0) {
                                                                showFrinedInfo(data, wxid, targetWxid, fnum);
                                                            } else {
                                                                console.log(data.resDesc);
                                                            }
                                                        } , "json");
                                            } else {
                                                showFrinedInfo(data, wxid, targetWxid, fnum);
                                            }
                                        } else {
                                            console.log(data.resDesc);
                                        }
                                    } , "json");
                        }

                        }
                        // $("#wechat_" + wxid).
                    }
            };
            socket.onopen = function(event) {
                var serviceId = 273;
                var msg = {"serviceId": serviceId};
                heartCheck.start();
                sendSocketMsg(1, JSON.stringify(msg));
            };
            socket.onclose = function(event) {
                //断开连接时操作
                // alert("您已经断开连接, 请刷新界面后重新上线");
                console.log(event);
                confirm("您已与服务器断开连接!请重新登录!");
                logout();


            };
            socket.onerror = function (event) {
                console.log("异常");
                console.log(event);
                // connectServer();
            }
        } else {
            alert("你的浏览器不支持 WebSocket！");
        }
    }


    function showPushRoomInfo(roomName, wxid, targetWxid, fnum, friendHead) {

        var serviceHtml = '';
        friendHead = friendHead ? friendHead : (basePath + "./static/img/defaultHeadPic.jpg");
        var showName = (roomName == null ? "" : roomName) + "(" +targetWxid + ")";


        var showTime = moment(new Date()).format('YYYY-MM-DD HH:mm:ss');
        var targetClassName = targetWxid.replace("@chatroom", "_chatroom");
        serviceHtml += '<li onclick="chooseChatRoom(\''+wxid+'\', \'' + targetWxid+ '\')"  id="'+wxid + targetClassName+'" data-name="'+roomName+targetClassName+'">' +
                '<div class="user_head"><img src="'+friendHead+'"/>';

        var showOrHide = '';

        serviceHtml += '<div class="msgNums" style="top:-10px;left:28px;'+showOrHide+'">'+fnum+'</div>\n';
        serviceHtml+='</div><div class="user_text">\n' +
                '<p class="user_name">'+showName+'</p>\n' +
                ' <p class="user_time">'+showTime+'</p>\n' +
                ' </div>\n' +
                '  </li>';


        $("#noRoomDataLi").hide();
        $("#"+wxid+targetClassName).remove();
        $("#talkingRoomList").prepend(serviceHtml);
    }

    function showFrinedInfo(data, wxid, targetWxid, fnum) {
        var fdata = data.data;
        var serviceHtml = '';
        var friendHead = '';
        var showName = '';
        var remark = '';
        var nickname = '';
        var remarkName = '';
        if (fdata != null) {
            friendHead = fdata.bigHeadPic;
            friendHead = friendHead ? friendHead : (basePath + "./static/img/defaultHeadPic.jpg");
            showName = (fdata.remarkName == null || fdata.remarkName == "") ? fdata.nickname : fdata.remarkName;
            remark = fdata.gexinqianming;
            nickname = fdata.nickname == null ? "" :  fdata.nickname;
            remarkName = fdata.remarkName == null ? "" :  fdata.remarkName;
        }

        var showTime = moment(new Date()).format('YYYY-MM-DD HH:mm:ss');
        var targetClassName = targetWxid.replace("@openim", "_openim")
        serviceHtml += '<li onclick="chooseFriend(\'' + wxid + '\', \'' + targetWxid + '\', \''+fdata.careId+'\')"  id="' + wxid + targetClassName + '" data-name="'+nickname+remarkName+'">' +
                '<div class="user_head"><img src="'+friendHead+'"/>';

        serviceHtml += '<div class="msgNums" style="top:-10px;left:28px;">'+fnum+'</div>\n';
        serviceHtml+='</div><div class="user_text">\n' +
                '<p class="user_name">'+showName+'</p>\n' +
                '<p class="user_message">'+remark+'</p>\n' +
                '</div>\n' +
                '<div class="user_time">'+showTime+'</div>\n' +
                '</li>';
        $("#noFriendDataLi").hide();
        $("#"+wxid+targetWxid).remove();
        $("#serviceFriendList").prepend(serviceHtml);
    }


    //关闭socket
    function closeSocket() {
        if (!window.WebSocket) {
            return;
        }
        if (socket == null || socket == undefined) {
            return;
        }
        if (socket.readyState == WebSocket.OPEN) {
            socket.close();
        } else {
            alert("连接没有开启.");
        }
    }


    /**
     * 封装消息, 并发送
     * @param message
     */
    function sendSocketMsg(msgType, message) {
        //封装信息
        var json = {"source_id":2, "msg_type" : msgType , "msg_content":message}

        if (!window.WebSocket) {
            return;
        }
        if (socket.readyState == WebSocket.OPEN) {
            socket.send(JSON.stringify(json));
        } else {
            alert("连接没有开启.");
        }
    }

    function logout() {
        //执行退出流程
        // doLogOut
        jQuery.post( "/doLogOut",
                function (data, textStatus){
                    if (data.resCode == 0) {
                        location.href = basePath + "/login";
                    } else {
                        alert(data.resDesc);
                    }
                } , "json")
    }


    function replaceDivAndBr(msg) {
        //替换换行符
        var reg = new RegExp("<div>","g");//g,表示全部替换。
        msg = msg.replace(reg,"\n");
        reg = new RegExp("<br>","g");
        msg =  msg.replace(reg,"");
        reg = new RegExp("</div>","g");
        msg = msg.replace(reg,"");


        var reg1 = new RegExp('\r', "g");
        msg = msg.replace(reg1, "");

        // var reg2 = new RegExp(/<[^>]+>|&nbsp;| /, "g");
        // msg = msg.replace(reg2, "");

        var reg2 = new RegExp('&nbsp;', "g");
        msg = msg.replace(reg2, " ");

        var reg3 = new RegExp('&gt;', "g");
        msg = msg.replace(reg3, ">");

        var reg4 = new RegExp('&lt;', "g");
        msg = msg.replace(reg4, "<");

        var reg5 = new RegExp('&amp;', "g");
        msg = msg.replace(reg5, "&");


        return msg;
    }

        function sender(){
            var msgData = dealCustomImg("inputBox");
            if (selectedFriend == null) {
                alert("请选择要发送的好友");
                return false;
            }
            if(msgData.length == 0){
                alert('不能发送空消息');
            }
            $.each(msgData, function (index, msg) {
                var oldMsg = msg;
                if (msg != null && msg != "") {
                    var uuid = guid();
                    // var height = 300 - ($("#chatbox").height() + );
                    // $("#chatbox").css({top:height+ "px"});
                    //处理表情
                    msg = dealQQFace(msg, "inputBox");
                    //替换换行符
                    msg = replaceDivAndBr(msg);
                    //socke发送内容
                    var contentType = 1;

                    if (msg.indexOf('class="customImg"') >= 0) {
                        var imgSrc = $(msg).attr("src");
                        var imgid = $(msg).attr("data-id");
                        var formData = new FormData();

                        showSendMsg(selectedWechat, selectedFriend, 2, 1, imgSrc, uuid);
                        // msg = imgSrc.replace("data:image/jpeg;base64,", "");

                        contentType = 2;//图片
                        if (imgid) {
                            formData.append('msgFile', imgFile.imgid);
                            formData.append("wxid", selectedWechat);
                            formData.append("targetWxid", selectedFriend);
                            formData.append("msgType", 2);

                            //见发送内容传到后台
                            $.ajax({
                                url: basePath + "http://47.115.80.88:8082/cs/sendMSgWithFile",
                                // url: "http://192.168.31.29:8002/cs/sendMSgWithFile",
                                type: "post",
                                data: formData,
                                contentType: false,
                                processData: false,
                                mimeType: "multipart/form-data",
                                success: function (data) {

                                    data = $.parseJSON(data);
                                    if (data.resCode == "0") {
                                        //发送成功
                                        $("#" + uuid).hide();
                                    } else {
                                        $("#" + uuid).removeClass("fa-spinner fa-pulse");
                                        $("#" + uuid).addClass("fa-info-circle fa-rotate-180");
                                        document.getElementById(uuid).style.color="red";
                                        // alert(data.resDesc);
                                    }
                                },
                                error: function (data) {

                                }
                            });
                        }else{
                            var idx = $(msg).attr("data-idx");
                            var json = {"wxid": selectedWechat, "targetWxid" : selectedFriend , "msgType": contentType, "quickMsgId": idx};
                            jQuery.post( "http://47.115.80.88:8082/cs/sendMsg", json,
                                    function (data, textStatus){
                                        if (data.resCode == 0) {
                                            //发送成功
                                            $("#" + uuid).hide();
                                        } else {
                                            $("#" + uuid).removeClass("fa-spinner fa-pulse");
                                            $("#" + uuid).addClass("fa-info-circle fa-rotate-180");
                                            document.getElementById(uuid).style.color="red";
                                            // alert(data.resDesc);
                                        }
                                    } , "json")
                        }
                    }else{
                        if (oldMsg.length > 50000) {
                            alert("发送内容过长!");
                        } else {
                            showSendMsg(selectedWechat, selectedFriend, 1, 1, oldMsg, uuid);
                            var json = {"wxid": selectedWechat, "targetWxid" : selectedFriend , "msgType": contentType, "msgContent": msg};
                            jQuery.post( "http://47.115.80.88:8082/cs/sendMsg", json,
                                    function (data, textStatus){
                                        if (data.resCode == 0) {
                                            //发送成功
                                            $("#" + uuid).hide();
                                        } else {
                                            $("#" + uuid).removeClass("fa-spinner fa-pulse");
                                            $("#" + uuid).addClass("fa-info-circle fa-rotate-180");
                                            document.getElementById(uuid).style.color="red";
                                            // alert(data.resDesc);
                                        }
                                    } , "json")
                            // sendSocketMsg(2, JSON.stringify(json));
                            //执行发送逻辑
                        }

                    }
                }
            });
            imgFile = {};
            $("#inputBox").html("");
        };

    function selectAllWechat(wxid) {
        jQuery.post( "http://47.115.80.88:8082/cs/selectAllWechat",
                function (data, textStatus){
                    if (data.resCode == 0) {
                        if(wxid){
                            for(var i=0; i<data.dataList.length; i++){
                                if(wxid == data.dataList[i].wxid){
                                    var headImg = data.dataList[i].bigHeadPic == "" ? basePath + "./static/img/defaultHeadPic.jpg" : data.dataList[i].bigHeadPic;
                                    var _wechatHtml = '<a id="wechat_'+ data.dataList[i].wxid+'"  href="javascript:chooseWechat(\''+ data.dataList[i].wxid + '\')" title="'+data.dataList[i].nickname+'">' +
                                            '<img src=" '+headImg+'" />'+
                                            '<span style="width:160px;float:right;margin-top:5px;">' +
                                            '<span style="width:160px;float:left;">'+ data.dataList[i].nickname +'</span>' +
                                            '<span style="width:160px;float:left;color: #cc8a56;">'+ data.dataList[i].wxid +'</span>' +
                                            '<img class="accountLine" src="'+basePath+'./static/img/online.png" style="width:16px;height:16px;display:block;" />' +
                                            '</span>';
                                    var showOrHide = '';
                                    if (data.dataList[i].noReadNum == 0) {
                                        showOrHide=' style="display:none;"';
                                    }
                                    _wechatHtml +=   '<div class="msgNums"  '+showOrHide+'>' + data.dataList[i].noReadNum + '</div>';
                                    _wechatHtml +=   '</a>';
                                    $("#wechat_" + wxid).remove();
                                    $("#wechatListDiv").prepend(_wechatHtml);
                                }
                            }
                        }else{
                            // var  wechatHtml = '<a id="wechat_all"  href="javascript:chooseWechat()" title="所有账号">' +
                            //         '<img src="'+basePath+'./static/img/defaultHeadPic.jpg" />'+
                            //         '<span style="width:160px;float:right;margin-top:5px;">' +
                            //         '<span style="width:160px;float:left;">所有账号</span>' +
                            //         '<span style="width:160px;float:left;color: #cc8a56;"></span>' +
                            //         '</span>';
                            var wechatHtml = '';
                            var dataList = data.dataList;
                            $.each(dataList, function (index, wechatData) {
                                var classHtml = '';
                                if (index == 0) {
                                    // selectedWechat = wechatData.wxid;
                                    // getWechatInfo(selectedWechat);
                                    // classHtml = 'class="active"';
                                    // chooseWechat(selectedWechat);
                                }
                                var headImg = wechatData.bigHeadPic == "" ? basePath + "./static/img/defaultHeadPic.jpg" : wechatData.bigHeadPic;
                                var onlineImg = wechatData.onlineStatus == 1 ? 'block':'none';
                                var offlineImg = wechatData.onlineStatus == 1 ? 'none':'block';
                                wechatHtml += '<a id="wechat_'+ wechatData.wxid+'"  href="javascript:chooseWechat(\''+ wechatData.wxid + '\')" title="'+wechatData.nickname+'" '+classHtml+'>' +
                                        '<img src=" '+headImg+'" />'+
                                        '<span style="width:160px;float:right;margin-top:3px;">' +
                                        '<span style="width:160px;float:left;">'+ wechatData.nickname +'</span>' +
                                        '<span style="width:160px;float:left;color: #cc8a56;">'+ wechatData.wxid +'</span>' +
                                        '<img class="accountLine" src="'+basePath+'./static/img/online.png" style="width:16px;height:16px;display:'+onlineImg+'" />' +
                                        '<img class="accountLine" src="'+basePath+'./static/img/offline.png" style="width:16px;height:16px;display:'+offlineImg+'" />' +
                                        '</span>';
                                var showOrHide = '';
                                if (wechatData.noReadNum == 0) {
                                    showOrHide=' style="display:none;"';
                                }
                                wechatHtml +=   '<div class="msgNums"  '+showOrHide+'>' + wechatData.noReadNum + '</div>';
                                wechatHtml +=   '</a>';
                            });

                            $("#wechatListDiv").html(wechatHtml);
                        }
                    } else {
                        console.log("selectAllWechat" + data.resDesc);
                        // alert(data.resDesc);
                    }
                } , "json")
    }


    function chooseWechat(wxid) {
        if (wxid != null) {
            $("#wechatListDiv .active").removeClass("active");
            $("#wechat_" + wxid).addClass("active");
            $('.wechat_list').animate({scrollTop:0},0);

            selectedWechat = wxid;
            if (selectedUserGroup == "fd") {
                var functionBtn = document.getElementById('si_' + selectedUserGroup);
                functionBtn.click();
            }

            if (selectedUserGroup == "room_list") {
                var functionBtn = document.getElementById('si_' + selectedUserGroup);
                functionBtn.click();
            }

            //选中的账号信息显示
            getWechatInfo(selectedWechat);
            //初始化选中的好友
            selectedFriend = null;
            $("#currentFriendName").html("");
            $("#chatbox").html("");
            $("#searchFriendInput").val("");
        } else {
            $("#wechatListDiv .active").removeClass("active");
            $("#wechat_all").addClass("active");
            selectedWechat = wxid;
            if (selectedUserGroup == "fd") {
                $("#si_msg").click();

                checkUserGroup('msg');
            }

            //选中的账号信息显示
            getWechatInfo(selectedWechat);
            //初始化选中的好友
            selectedFriend = null;
            $("#currentFriendName").html("");
            $("#chatbox").html("");
            $("#searchFriendInput").val("");
        }

    }

    /**
     * 获取账号信息
     */
    function getWechatInfo(wxid) {
        if (wxid == null) {
            $("#selectedHeadPic").attr("src", basePath + "./static/img/defaultHeadPic.jpg");
            $("#selectedWechatName").html("所有账号");
            $("#selectedWechatWxid").html("...");
            $("#selectedWechatHead").attr("src",  basePath + "./static/img/defaultHeadPic.jpg");
            $("#selectedWechatArea").html("...");
        } else {
            jQuery.post( "http://47.115.80.88:8082/cs/getWechatInfo?wxid=" + wxid,
                    function (data, textStatus){
                        if (data.resCode == 0) {
                            var wechatInfo = data.data;
                            var headPic = wechatInfo.bigHeadPic == "" ? basePath + "./static/img/defaultHeadPic.jpg" : wechatInfo.bigHeadPic;
                            $("#selectedHeadPic").attr("src", headPic);
                            $("#selectedWechatName").html(wechatInfo.nickname);
                            $("#selectedWechatWxid").html(wechatInfo.wxid);
                            $("#selectedWechatHead").attr("src", headPic);
                            $("#selectedWechatArea").html(parseProvince(wechatInfo.province) + " " + parseCity(wechatInfo.province, wechatInfo.city));
                            var sex = wechatInfo.sex;
                            if (sex == 2) {
                                $("#sexSpan").css({color: 'palevioletred'});
                                $("#sexSpan").removeClass("fa-male");
                                $("#sexSpan").addClass("fa-female");
                            } else {
                                $("#sexSpan").css({color: 'dodgerblue'});
                                $("#sexSpan").removeClass("fa-female");
                                $("#sexSpan").addClass("fa-male");
                            }
                        } else {
                            console.log("getWechatInfo" +data.resDesc)
                            //alert(data.resDesc);
                        }
                    } , "json")
        }

    }

    //生成uuid
    function guid() {
        function S4() {
            return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
        }
        return (S4()+S4()+S4()+S4()+S4()+S4()+S4()+S4());
    }


    function doSearchMoreFriend() {
        if (lastQueryTime) {
            if(isSelectTwoRead === 1){
                selectTwoRead(selectedReadStatus, lastQueryTime)
            }else {
                selectWechatFriend(selectedReadStatus, lastQueryTime)
            }
        }
    }

    //查询出微信的服务好友
    function selectWechatFriend(readStatus, lastQueryTime1) {
        readStatus = readStatus ? readStatus : 0;
        selectedReadStatus = readStatus;
        isSelectTwoRead =0;
        var searchUrl = "http://47.115.80.88:8082/cs/selectServiceFriendList?readStatus=" + readStatus;
        var isAdd = false;
        if (lastQueryTime1) {
            isAdd = true;
            console.log(lastQueryTime1 + "+lastQueryTime")
            searchUrl += "&lastQueryTime=" + lastQueryTime1;
        } else {
            $("#serviceFriendList").html('<li>数据加载中...</li>');
        }

        jQuery.post(searchUrl,
                function (data, textStatus){
                    if (data.resCode == 0) {
                        var dataList =  data.dataList;
                        var serviceHtml = '';
                        if (dataList.length == 0) {
                            if (isAdd) {
                                $("#serviceFriendList").append('<li id="noFriendDataLi">没有更多数据</li>');
                                $("#getMoreFriendBtn").hide();
                            } else {
                                $("#serviceFriendList").html('<li id="noFriendDataLi">没有数据</li>');
                                $("#getMoreFriendBtn").hide();
                            }

                        } else {
                            var emptyDatas = [];
                            $.each(dataList, function (index, fdata) {
                                if (index == 199) {
                                    lastQueryTime = fdata.lastTalkTime;
                                    $("#getMoreFriendBtn").show();
                                } else {
                                    $("#getMoreFriendBtn").hide();
                                }
                                var friendHead = fdata.bigHeadPic;
                                friendHead = friendHead ? friendHead : (basePath + "./static/img/defaultHeadPic.jpg");
                                var showName = (fdata.remarkName == null || fdata.remarkName == "") ? fdata.nickname : fdata.remarkName;

                                if (showName == null || showName == "") {
                                    showName = fdata.wxid;
                                  emptyDatas.push({"wxid": fdata.wxid, "targetWxid": fdata.targetWxid});
                                }

                                var remark = fdata.remark;
                                var showTime = fdata.lastTalkTime == null ? "" :  moment(new Date(fdata.lastTalkTime)).format('YYYY-MM-DD HH:mm:ss');
                                var targetClassName = fdata.targetWxid.replace("@openim", "_openim");
                                serviceHtml += '<li onclick="chooseFriend(\''+fdata.wxid+'\', \'' + fdata.targetWxid+ '\', \'' + fdata.careId+ '\')"  id="'+fdata.wxid + targetClassName+'" data-name="'+fdata.nickname+fdata.remarkName+'">' +
                                        '<div class="user_head"><img src="'+friendHead+'"/>';

                                var showOrHide = '';
                                if (fdata.noReadNum  == 0) {
                                    showOrHide='display:none;';
                                }

                                serviceHtml += '<div class="msgNums" style="top:-10px;left:28px;'+showOrHide+'">'+fdata.noReadNum+'</div>\n';
                                serviceHtml+='</div><div class="user_text">\n' +
                                        '<p class="user_name">'+showName+'</p>\n' +
                                        ' <p class="user_message">'+remark+'</p>\n' +
                                        ' </div>\n' +
                                        '<div class="user_time">'+showTime+'</div>\n' +
                                        '  </li>';
                            });
                            if (isAdd) {
                                $("#serviceFriendList").append(serviceHtml);
                            } else {
                                $("#serviceFriendList").html(serviceHtml);
                            }

                            if (emptyDatas.length > 0) {
                                $.each(emptyDatas, function (index, value) {
                                    jQuery.post("http://47.115.80.88:8082/cs/freshContactDetail", {"wxid": value.wxid, "targetWxid": value.targetWxid},
                                            function (data, textStatus){
                                                if (data.resCode == 0) {
                                                    var targetClassName = value.targetWxid.replace("@openim", "_openim");
                                                    $("#"+value.wxid + targetClassName+" .user_head").attr("src", data.data.bigHeadPic);
                                                    var fName = (data.data.remarkName == null  ||data.data.remarkName  == "") ? data.data.nickname : data.data.remarkName;
                                                    $("#"+value.wxid + targetClassName+" .user_name").html(fName);

                                                    var gexinqianming = data.data.gexinqianming;
                                                    $("#"+value.wxid + targetClassName+" .user_message").html(gexinqianming);


                                                } else {
                                                    console.log(data.resDesc);
                                                }
                                            } , "json");
                                });
                            }

                        }

                    } else {
                        console.log("selectWechatFriend" + data.resDesc);
                        //alert(data.resDesc);
                    }
                } , "json")
    }


    //查询未读消息超过两条的数据
    function selectTwoRead(readStatus, lastQueryTime1) {
        readStatus = readStatus ? readStatus : 0;
        selectedReadStatus = readStatus;
        isSelectTwoRead =1;
        var searchUrl = "http://47.115.80.88:8082/cs/selectServiceFriendList?readStatus=" + readStatus;
        var isAdd = false;
        if (lastQueryTime1) {
            isAdd = true;
            console.log(lastQueryTime1 + "+lastQueryTime")
            searchUrl += "&lastQueryTime=" + lastQueryTime1;
        } else {
            $("#serviceFriendList").html('<li>数据加载中...</li>');
        }

        jQuery.post(searchUrl,
            function (data, textStatus){
                if (data.resCode == 0) {
                    var dataList =  data.dataList;
                    var serviceHtml = '';
                    if (dataList.length == 0) {
                        if (isAdd) {
                            $("#serviceFriendList").append('<li id="noFriendDataLi">没有更多数据</li>');
                            $("#getMoreFriendBtn").hide();
                        } else {
                            $("#serviceFriendList").html('<li id="noFriendDataLi">没有数据</li>');
                            $("#getMoreFriendBtn").hide();
                        }

                    } else {
                        var emptyDatas = [];
                        $.each(dataList, function (index, fdata) {
                            if(fdata.noReadNum > 1){
                            if (index == 199) {
                                lastQueryTime = fdata.lastTalkTime;
                                $("#getMoreFriendBtn").show();
                            } else {
                                $("#getMoreFriendBtn").hide();
                            }
                            var friendHead = fdata.bigHeadPic;
                            friendHead = friendHead ? friendHead : (basePath + "../static/img/defaultHeadPic.jpg");
                            var showName = (fdata.remarkName == null || fdata.remarkName == "") ? fdata.nickname : fdata.remarkName;

                            if (showName == null || showName == "") {
                                showName = fdata.wxid;
                                emptyDatas.push({"wxid": fdata.wxid, "targetWxid": fdata.targetWxid});
                            }

                            var remark = fdata.remark;
                            var showTime = fdata.lastTalkTime == null ? "" : moment(new Date(fdata.lastTalkTime)).format('YYYY-MM-DD HH:mm:ss');
                            var targetClassName = fdata.targetWxid.replace("@openim", "_openim");
                            serviceHtml += '<li onclick="chooseFriend(\'' + fdata.wxid + '\', \'' + fdata.targetWxid + '\', \'' + fdata.careId + '\')"  id="' + fdata.wxid + targetClassName + '" data-name="' + fdata.nickname + fdata.remarkName + '">' +
                                '<div class="user_head"><img src="' + friendHead + '"/>';

                            var showOrHide = '';
                            if (fdata.noReadNum == 0) {
                                showOrHide = 'display:none;';
                            }

                            serviceHtml += '<div class="msgNums" style="top:-10px;left:28px;' + showOrHide + '">' + fdata.noReadNum + '</div>\n';
                            serviceHtml += '</div><div class="user_text">\n' +
                                '<p class="user_name">' + showName + '</p>\n' +
                                ' <p class="user_message">' + remark + '</p>\n' +
                                ' </div>\n' +
                                '<div class="user_time">' + showTime + '</div>\n' +
                                '  </li>';
                        }
                        });
                        if (isAdd) {
                            $("#serviceFriendList").append(serviceHtml);
                        } else {
                            $("#serviceFriendList").html(serviceHtml);
                        }

                        if (emptyDatas.length > 0) {
                            $.each(emptyDatas, function (index, value) {
                                jQuery.post("http://47.115.80.88:8082/cs/freshContactDetail", {"wxid": value.wxid, "targetWxid": value.targetWxid},
                                    function (data, textStatus){
                                        if (data.resCode == 0) {
                                            var targetClassName = value.targetWxid.replace("@openim", "_openim");
                                            $("#"+value.wxid + targetClassName+" .user_head").attr("src", data.data.bigHeadPic);
                                            var fName = (data.data.remarkName == null  ||data.data.remarkName  == "") ? data.data.nickname : data.data.remarkName;
                                            $("#"+value.wxid + targetClassName+" .user_name").html(fName);

                                            var gexinqianming = data.data.gexinqianming;
                                            $("#"+value.wxid + targetClassName+" .user_message").html(gexinqianming);


                                        } else {
                                            console.log(data.resDesc);
                                        }
                                    } , "json");
                            });
                        }

                    }

                } else {
                    console.log("selectWechatFriend" + data.resDesc);
                    //alert(data.resDesc);
                }
            } , "json")
    }

    //查询出微信的所有好友
    function selectWechatAllFriend() {
        if  (!selectedWechat) {
            alert("请选择账号!");
        } else {
            var wxid = selectedWechat;
            jQuery.post( "http://47.115.80.88:8082/cs/selectAllWechatFriends", {"wxid": wxid},
                    function (data, textStatus){
                        if (data.resCode == 0) {
                            console.log(allFriendsList);
                            allFriendsList = data.dataList;
                            initFriendList();
                        } else {
                            console.log("selectWechatAllFriend" + data.resDesc);
                            //alert(data.resDesc);
                        }
                    } , "json")
        }
        // selectAllWechatFriends


    }



    //初始化好友列表
    function initFriendList(keywords) {
        var listHtml = '';
        $.each(allFriendsList,  function (index, friendData) {
            var friendHead = friendData.smallHeadPic;
            friendHead = friendHead ? friendHead : (basePath +"./static/img/defaultHeadPic.jpg");
            var showName = friendData.remarkName == "" ? friendData.nickname : friendData.remarkName;
            var targetClassName = friendData.wxid.replace("@openim", "_openim")

            var fhtml = '<li onclick="chooseFriend(\''+friendData.ownerWxid+'\',\'' + friendData.wxid+ '\', \''+friendData.careId+'\')" id="'+friendData.ownerWxid + targetClassName+'" data-name="'+friendData.nickname+friendData.remarkName+'" >' +
                    '<div class="friends_box">' +
                    '<div class="user_head"><img src="'+friendHead+'"/></div>\n' +
                    '<div class="friends_text">\n' +
                    '<p class="user_name">'+ showName +'</p>' +
                    '</div>' +
                    '</div>' +
                    '</li>';
            if (keywords == null || keywords == "") {
                listHtml += fhtml;
            } else {
                if (friendData.remarkName.indexOf(keywords) >= 0 || friendData.nickname.indexOf(keywords) >= 0) {
                    listHtml += fhtml;
                }
            }

        });
        if (listHtml == '') {
            listHtml = ' <li><p>没有所筛选的好友</p></li>';
        }
        $("#allFriendList").html(listHtml);
    }


    //本地搜索好友
    function searchFriend() {
        var keywords = $("#searchFriendInput").val();
        //搜索时, 回到顶部
        $("#allFriendList").css({top:0});
        initFriendList(keywords);
    }




    /**
     * 执行选择好友操作
     * @param doc
     */
    function chooseFriend(wxid, targetWxid, careId) {
        $("#friendInfoTable").show();
        $("#chatRoomInfoTable").hide();

        selectedFriend = targetWxid;
        selectedWechat = wxid;
        careWechatId = wxid;

        $("#careBtnDiv").show();
        if(careId == -1){
            $('.care-un').show();
            $('.care-ed').hide();
        }else{
            $('.care-un').hide();
            $('.care-ed').show();
        }

        $("#allFriendList .active").removeClass("active");
        $("#wechatListDiv a").removeClass('active')
        $("#wechat_" + selectedWechat).addClass("active")
        var targetClassName = targetWxid.replace("@openim", "_openim")
        var fname = $("#" + wxid +targetClassName + " .user_name").html();
        $('#inputBox').focus();


        //TODO 查询出好友与本人的聊天记录
        // var wxid = selectedWechat;
        //查询聊天记录
        var headPic = $("#" +wxid + targetClassName  + " .user_head img")[0].outerHTML;
        var headImgSrc;
        jQuery.post( "http://47.115.80.88:8082/cs/getWechatInfo?wxid=" + wxid,
                function (data, textStatus){
                    if (data.resCode == 0) {
                        var wechatInfo = data.data;
                        sendHeaderImg = wechatInfo.bigHeadPic;
                        sendHeaderImg = sendHeaderImg ? sendHeaderImg : (basePath +"./static/img/defaultHeadPic.jpg");
                        $("#currentFriendName").html(wechatInfo.nickname + '('+wxid+')的好友:' +fname);
                        headImgSrc = wechatInfo.bigHeadPic;
                        headImgSrc = headImgSrc ? headImgSrc :(basePath +"./static/img/defaultHeadPic.jpg");
                        jQuery.post( "http://47.115.80.88:8082/cs/selectTalkList", {"wxid": wxid, "targetWxid": targetWxid},
                                function (data, textStatus){
                                    if (data.resCode == 0) {
                                        var nums = $("#wechat_" + wxid + " .msgNums").html();

                                        var fnum =$("#" +wxid + targetClassName + " .msgNums").html();

                                        $("#wechat_" + wxid + " .msgNums").html(parseInt(nums) - parseInt(fnum));
                                        if (parseInt(fnum) >= parseInt(nums)) {
                                            $("#wechat_" + wxid + " .msgNums").hide();
                                        }
                                        $("#" +wxid + targetClassName+ " .msgNums").html(0);
                                        $("#" +wxid + targetClassName + " .msgNums").hide();

                                        var talkHtml = '';
                                        $.each(data.dataList, function (index) {
                                            var talkData = data.dataList[data.dataList.length - index - 1];
                                            var msg_content = talkData.msg_content;
                                            if (msg_content.indexOf("\n") > -1) {
                                                var reg = new RegExp("\n","g");//g,表示全部替换。
                                                msg_content = msg_content.replace(reg, "<br>");
                                            }
                                            // if(talkData.target_type == 1) {
                                            //     //自己发出的消息
                                            //     talkHtml += '<li class="me"><img style="width:34px;" src="'+ headImgSrc +'"/><span>'+msg_content+'</span></li>';
                                            // } else {
                                            //     talkHtml += '<li class="other">'+headPic+'<span>'+msg_content+'</span></li>';
                                            // }
                                            if(talkData.msg_type == 10000){
                                                talkHtml+= '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>'
                                                talkHtml += '<li class="timer" style="margin: 10px 0;font-size: 12px; padding: 0 5px;line-height: 16px;">系统消息: ' + talkData.msg_content + '</li>'
                                            }

                                            if(talkData.target_type == 1) {
                                                //自己发出的消息
                                                if(talkData.msg_type == 1){
                                                    msg_content =  replaceFace(msg_content);
                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                            '<li class="me">' +
                                                            '<img style="width:34px;" src="'+ headImgSrc +'"/>' +
                                                            '<span>'+msg_content+'</span>' +
                                                            '</li>';
                                                }else if(talkData.msg_type == 2){
                                                    if (msg_content.indexOf("http://") == -1 && msg_content.indexOf("base64") == -1) {
                                                        msg_content = "data:image/jpeg;base64," + msg_content;
                                                    }
                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                            '<li class="me"><img style="width:34px;" src="'+ headImgSrc +'"/>' +
                                                            '<img src="'+msg_content+'" style="width:100px;height:100px;margin:0 10px;" onclick="showSendImg(this, \''+talkData.record_id+'\')" />' +
                                                            '</li>';
                                                }else if(talkData.msg_type == 3){
                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                            '<li class="me"><img style="width:34px;" src="'+ headImgSrc +'"/><div class="lengthDivMe" style="width:150px;height:39px;background:#9EEA6A;border-radius:4px;padding:3px 5px;margin-right:40px;" onclick="javascript:playVoice(this, \''+msg_content+'\')"><div class="voiceBg" style="margin-top:5px;"></div></div>' +
                                                            '</li>';
                                                } else if (talkData.msg_type == 4){
                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                    '<li class="me"><img style="width:34px;" src="'+ headImgSrc +'">';
                                                    talkHtml += '<span class="lengthDivMe">';
                                                var obj=JSON.parse(msg_content);
                                                var cardHead = basePath +"./static/img/defaultHeadPic.jpg"
                                                var cardName = msg_content;
                                                if(typeof obj == 'object' && obj ){
                                                    cardHead = obj.smallHeadImg;
                                                    cardName = obj.nickname;
                                                    if (cardName) {
                                                        cardName = cardName ? cardName : "未知";
                                                    }
                                                    cardHead = cardHead ? cardHead :  (basePath +"./static/img/defaultHeadPic.jpg");
                                                }

                                                talkHtml += '<div style="width:200px;height:70px;border:1px gray solid;background-color:white;">' +
                                                        '<div style="height:40px;width:100%;"><img src='+cardHead+' style="margin:2px;width:35px;height:35px;float:left;"><i style="margin-left:10px;padding-top:10px;">'+cardName+'</i></div>' +
                                                        '<div style="width:100%;height:15px;border-top: #ccc 1px solid;padding-left:20px;font-size:12px;">个人名片</div>' +
                                                        '</div>'
                                                talkHtml +=    '</span></div></li>';
                                                }
                                            } else {
                                                if(talkData.msg_type == 1){
                                                    msg_content =  replaceFace(msg_content);
                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                            '<li class="other">'+headPic+'<span>'+msg_content+'</span>' +
                                                            '</li>';
                                                }else if(talkData.msg_type == 2){
                                                    if (msg_content.indexOf("http://") == -1 && msg_content.indexOf("base64") == -1) {
                                                        msg_content = "data:image/jpeg;base64," + msg_content;
                                                    }
                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                            '<li class="other">'+headPic+'' +
                                                            '<img src="'+msg_content+'" style="width:100px;height:100px;margin:0 10px;" onclick="showSendImg(this, \''+talkData.record_id+'\')" />' +
                                                            '</li>';
                                                }else if(talkData.msg_type == 3){
                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                            '<li class="other">'+headPic+'<div class="lengthDiv" style="width:150px;height:39px;background:#9EEA6A;border-radius:4px;padding:3px 5px;margin-left:45px;" onclick="javascript:playVoice(this, \''+msg_content+'\')">' +
                                                            '<div class="voiceBg" style="margin-top:5px;"></div></div>' +
                                                            '</li>';
                                                } else if (talkData.msg_type == 4){
                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                            '<li class="other">' + headPic
                                                    talkHtml +=  '<span class="">' ;
                                                    var obj=JSON.parse(msg_content);
                                                    var cardHead = basePath +"./static/img/defaultHeadPic.jpg"
                                                    var cardName = msg_content;
                                                    if(typeof obj == 'object' && obj ){
                                                        cardHead = obj.smallHeadImg;
                                                        cardName = obj.nickname;
                                                        if (cardName) {
                                                            cardName = cardName ? cardName : "未知";
                                                        }
                                                        cardHead = cardHead ? cardHead :  (basePath +"./static/img/defaultHeadPic.jpg");
                                                    }

                                                    talkHtml += '<div style="width:200px;height:70px;border:1px gray solid;background-color:white;">' +
                                                            '<div style="height:40px;width:100%;"><img src='+cardHead+' style="margin:2px;width:35px;height:35px;float:left;"><i style="margin-left:10px;padding-top:10px;">'+cardName+'</i></div>' +
                                                            '<div style="width:100%;height:15px;border-top: #ccc 1px solid;padding-left:20px;font-size:12px;">个人名片</div>' +
                                                            '</div>'
                                                    talkHtml +=    '</span></div></li>';
                                                }
                                            }




                                        });
                                        $("#msgBody .content").html(talkHtml);
                                        // $("#chatbox").css({bottom:0});

                                        if ($('#msgBody .office_text').height() > $("#chatbox").height()) {
                                            $("#chatbox").css({top:0});
                                        }else{
                                            var height = $('#msgBody .office_text').height() - 20 - $("#chatbox").height();
                                            $("#chatbox").css({top:height+ "px"})
                                        }

                                    } else {
                                        console.log("selectTalkList" + data.resDesc);
                                        // alert(data.resDesc);
                                    }
                                } , "json")
                    } else {
                        console.log("getWechatInfo" + data.resDesc);
                        //alert(data.resDesc);
                    }
                } , "json")

        if (sideMove) {
            showFriendData();
        }
    }


        function checkUserGroup(gtype) {
            gtype = (!gtype) ? 'msg' : gtype;
            selectedUserGroup = gtype;
            $(".sidestrip_icon .selected").removeClass("selected");
            $(".sidestrip_icon .fa-comment").addClass("fa-comment-o").removeClass("fa-comment");
            $(".sidestrip_icon .fa-bookmark").addClass("fa-bookmark-o").removeClass("fa-bookmark");
            $(".sidestrip_icon .fa-user").addClass("fa-user-o").removeClass("fa-user");
            $(".sidestrip_icon .fa-comments").addClass("fa-comments-o").removeClass("fa-comments");



            if (gtype == 'msg') {
                $("#si_msg").addClass("fa-comment");
                $("#si_msg").addClass("selected");
                $("#si_msg").removeClass("fa-comment-o");

                // selectWechatFriend();

            } else if (gtype == 'mark') {
                $("#si_mark") .addClass("fa-bookmark");
                $("#si_mark") .addClass("selected");
                $("#si_mark").removeClass("fa-bookmark-o");
                selectFriendByCare();
                getCareList(null, 'care');
            } else if (gtype == 'fd') {
                $("#si_fd").addClass("fa-user")
                $("#si_fd").addClass("selected")
                $("#si_fd").removeClass("fa-user-o");

                selectWechatAllFriend();
                $("#allFriendList").css({top:0});
            } else if (gtype == 'room_msg') {
                $("#si_room_msg").addClass("fa-comments");
                $("#si_room_msg").addClass("selected");
                $("#si_room_msg").removeClass("fa-comments-o");

                $("#roomList1").click();
                //是否已经查询出信息, 如果未查询, 调用查询, 如果已查询, 直接显示

            } else if (gtype == 'room_list') {
                $("#si_room_list").addClass("selected");
                selectAllRoomList();
                $("#allRoomList").css({top:0});
            }

        }




    //showSendMsg(wxid, targetWxid, msgType, targetType, msg);
    function replaceFace(msg) {
        if (msg.indexOf("\n") > -1) {
            var reg = new RegExp("\n","g");//g,表示全部替换。
            msg = msg.replace(reg, "<br>");
        }
        var r = /\[(.+?)\]/g;
        var QQFaceList = ["微笑", "撇嘴", "色", "发呆", "得意", "流泪", "害羞", "闭嘴", "睡", "大哭", "尴尬", "发怒", "调皮", "呲牙", "惊讶", "难过", "酷", "冷汗", "抓狂", "吐", "偷笑", "愉快", "白眼", "傲慢", "饥饿", "困", "惊恐", "流汗", "憨笑", "悠闲", "奋斗", "咒骂", "疑问", "嘘", "晕", "疯了", "衰", "骷髅", "敲打", "再见", "擦汗", "抠鼻", "鼓掌", "糗大了", "坏笑", "左哼哼", "右哼哼", "哈欠", "鄙视", "委屈", "快哭了", "阴险", "亲亲", "吓", "可怜", "菜刀", "西瓜", "啤酒", "篮球", "乒乓", "咖啡", "饭", "猪头", "玫瑰", "凋谢", "嘴唇", "爱心", "心碎", "蛋糕", "闪电", "炸弹", "刀", "足球", "瓢虫", "便便", "月亮", "太阳", "礼物", "拥抱", "强", "弱", "握手", "胜利", "抱拳", "勾引", "拳头", "差劲", "爱你", "NO", "OK", "爱情", "飞吻", "跳跳", "发抖", "怄火", "转圈", "磕头", "回头", "跳绳", "投降", "激动", "乱舞", "献吻", "左太极", "右太极", "嘿哈", "捂脸", "奸笑", "机智", "皱眉", "耶", "红包", "鸡"];
        var faces = msg.match(r);


        // if (!isObjEmpty(faces)) {
        //     var option = options[0]
        //     if (!isObjEmpty(option)) {
        //         result = option.substring(1, option.length - 1)
        //     }
        // }

        if(faces) {
            $.each(faces, function(index, faceName) {
                faceName = faceName.replace("\]", "");
                faceName = faceName.replace("\[", "");
                if (QQFaceList.indexOf(faceName) > -1) {

                    msg = msg.replace("\[" + faceName + "\]", '<img src="'+basePath+'./static/img/qqface/'+faceName+'.png">');
                }

            });
        }

        return msg;
    }

    function readFriendMsg(wxid, targetWxid) {
        if (targetWxid.indexOf("@chatroom") != -1) {
            jQuery.post( "http://47.115.80.88:8082/cs/readRoomMsg", {"wxid": wxid, "wxRoomId": targetWxid},
                    function (data, textStatus){
                        if (data.resCode == 0) {
                            //当好友信息为空时, 调用fresh操作
                        } else {
                            console.log(data.resDesc);
                        }
                    } , "json");
        } else {
            jQuery.post( "http://47.115.80.88:8082/cs/readFriendMsg", {"wxid": wxid, "targetWxid": targetWxid},
                    function (data, textStatus){
                        if (data.resCode == 0) {
                            //当好友信息为空时, 调用fresh操作
                        } else {
                            console.log(data.resDesc);
                        }
                    } , "json");
        }
    }

    //展示发送的当前信息
    function showSendMsg(wxid, targetWxid, msgType, targetType, msg, uuid, recordId, sendWxid) {
        // var text = document.getElementById('inputBox');
        var chat = document.getElementById('chatbox');
        // var talk = document.getElementById('talkbox');
        var headImgSrc;
        var className;
        var talkHtml;
        var nameStr = '';

        msg = replaceFace(msg)

        if (targetType == 1) {
            headImgSrc = sendHeaderImg;
            headImgSrc = headImgSrc ? headImgSrc : (basePath +"./static/img/defaultHeadPic.jpg")
            className = 'me';

            chat.scrollTop=chat.scrollHeight;
            // talk.style.background="#fff";
            // text.style.background="#fff";
        } else {
            //获取选中的好友的头像
            var targetClassName = targetWxid.replace("@openim", "_openim")
            targetClassName = targetClassName.replace("@chatroom", "_chatroom")
            headImgSrc = $("#" + wxid + targetClassName + " .user_head img").attr("src");
            headImgSrc = headImgSrc ? headImgSrc : (basePath +"./static/img/defaultHeadPic.jpg")
            //TODO 显示图片调用接口
            className = 'other';

             if (targetWxid.indexOf("@chatroom")  != -1) {
                 //获取sendWxid
                 var sendWxidData = selectedRoomMemInfo.get(sendWxid);
                 if (sendWxidData) {
                     headImgSrc = sendWxidData.bigImgHead;
                     nameStr = "<i>" +sendWxidData.nickName+ "</i><br>";
                 } else {
                     headImgSrc = basePath +"./static/img/defaultHeadPic.jpg"
                     nameStr = "<i>" +sendWxid+ "</i><br>";
                 }

             }

        }


        if (msgType == 1) {
            talkHtml = '<li class="'+className+'"><img style="width:34px;" src="'+ headImgSrc +'">';

            if (targetType == 1) {
                talkHtml += '<span>'+msg+'</span>';
                talkHtml +=  '<i id="'+uuid+'"  style="color:#ccc;position: relative;margin-top: 10px;" class="fa fa-spinner fa-pulse fa-fw"></i>';
            } else {
                talkHtml += '<div>'+nameStr+'<span>'+msg+'</span></div>';
            }
        }else if (msgType == 2) {
            if (msg.indexOf("http://") == -1 && msg.indexOf("base64") == -1) {
                msg = "data:image/jpeg;base64," + msg;
            }
            talkHtml = '<li class="'+className+'"><img style="width:34px;" src="'+ headImgSrc +'"/>';
            if (targetType == 1) {
                talkHtml +=   '<img src="'+msg+'" style="width:100px;height:100px;margin:0 10px;" onclick="showSendImg(this, \''+recordId+'\')" />';
                talkHtml +=  '<i id="'+uuid+'"  style="color:#ccc;position: relative;margin-top: 10px;" class="fa fa-spinner fa-pulse fa-fw"></i>';
            } else {
                talkHtml +=  '<div>'+nameStr+'<img src="'+msg+'" style="width:100px;height:100px;margin:0 10px;" onclick="showSendImg(this, \''+recordId+'\')" /></div>';
            }
        }else if (msgType == 3) {
            talkHtml = '<li class="timer">' + moment(new Date()).format("YYYY-MM-DD HH:mm:ss") + '</li>' +
                    '<li class="'+className+'"><img style="width:34px;" src="'+ headImgSrc +'">' + nameStr;
            if (targetType == 1) {
                talkHtml += '<div class="lengthDivMe" style="width:150px;height:39px;background:#9EEA6A;border-radius:4px;padding:3px 5px;margin-right:45px;"' ;
            } else {
                talkHtml +=  '<div class="lengthDiv" style="width:150px;height:39px;background:#9EEA6A;border-radius:4px;padding:3px 5px;margin-left:45px;"' ;

            }
            talkHtml +=    'onclick="javascript:playVoice(this, \''+msg+'\')"><div class="voiceBg" style="margin-top:5px;"></div></div>';
            if (targetType == 1) {
                talkHtml +=  '<i id="'+uuid+'"  style="color:#ccc;position: relative;top:-30px; left:-20px;" class="fa fa-spinner fa-pulse fa-fw"></i>';
            }
        } else if (msgType == 4) {
            talkHtml = '<li class="timer">' + moment(new Date()).format("YYYY-MM-DD HH:mm:ss") + '</li>' +
                    '<li class="'+className+'"><img style="width:34px;" src="'+ headImgSrc +'">' + nameStr;
            if (targetType == 1) {
                talkHtml += '<span class="lengthDivMe">';
            } else {
                talkHtml +=  '<span class="">' ;
            }
            var obj=JSON.parse(msg);
            var cardHead = basePath +"./static/img/defaultHeadPic.jpg"
            var cardName = msg;
            if(typeof obj == 'object' && obj ){
                cardHead = obj.smallHeadImg;
                cardName = obj.nickname;
                if (cardName) {
                    cardName = cardName ? cardName : "未知";
                }
                cardHead = cardHead ? cardHead :  (basePath +"./static/img/defaultHeadPic.jpg");
            }

            talkHtml += '<div style="width:200px;height:70px;border:1px gray solid;background-color:white;">' +
                    '<div style="height:40px;width:100%;"><img src='+cardHead+' style="margin:2px;width:35px;height:35px;float:left;"><i style="margin-left:10px;padding-top:10px;">'+cardName+'</i></div>' +
                    '<div style="width:100%;height:15px;border-top: #ccc 1px solid;padding-left:20px;font-size:12px;">个人名片</div>' +
                    '</div>'
            talkHtml +=    '</span></div>';
        } else if(msgType == 10000){
            talkHtml += '<li class="timer">' + moment(new Date()).format('YYYY-MM-DD HH:mm:ss') + '</li>'
            talkHtml += '<li class="timer" style="margin: 10px 0;font-size: 12px; padding: 0 5px; line-height: 16px;">系统消息: ' + msg + '</li>'
        }

        talkHtml += '</li>';
        $("#msgBody .content").append(talkHtml);
        // $("#chatbox").css({bottom:0});
        var height = $('#msgBody .office_text').height() - 20 - $("#chatbox").height();
        $("#chatbox").css({top:height+ "px"})
    }

    /**
     * 获取表情内容
     * @param divId
     * @returns {jQuery}
     */
    function getQQFaceContent(divId) {
        var contentData = $("#" + divId).html();
        var imglist=$("#"+divId+" .imgFace");
        //表情替换
        $.each(imglist, function (index, imgData) {
            var value = '[' + $(imgData).attr("data-name") + ']';
            if (value == "" || value == undefined) {

            } else {
                contentData = contentData.replace(imgData.outerHTML, value);
            }
        });
        return contentData;
    }

    function dealQQFace(content, divId) {
        var imglist=$("#"+divId+" .imgFace");
        //表情替换
        $.each(imglist, function (index, imgData) {
            var value = '[' + $(imgData).attr("data-name") + ']';
            if (value == "" || value == undefined) {

            } else {
                content = content.replace(imgData.outerHTML, value);
            }
        });
        return content;
    }

    function dealCustomImg(divId) {
        var contentData = $("#" + divId).html();
        //图片处理
        var customImgList  = $("#" +divId +" .customImg");
        $.each(customImgList, function (index, imgData) {
            contentData = contentData.replace(imgData.outerHTML, "<_>" + imgData.outerHTML + "<_>");
        });
        var msgData = contentData.split("<_>");
        var dataList = new Array();
        $.each(msgData, function (index, msg) {
            if (msg != null && msg != "") {
                dataList.push(msg);
            }
        });
        return dataList;
    }

    function selectByKeyWords() {
        var keyWords = $("#searchQuickMsgKeyWords").val();
        selectQuickMsgPageList(1, 10, keyWords, selectedQuickMsgType)
    }

    function nextPage() {
        var currPageNo = $("#pageNoData").val();
        var totalNo = $("#totalRecordsData").val();
        var keyWords = $("#searchQuickMsgKeyWords").val();
        currPageNo = parseInt(currPageNo);
        totalNo = parseInt(totalNo);
        var nextPageNo = (currPageNo + 1) > totalNo ? totalNo : (currPageNo + 1);
        selectQuickMsgPageList(nextPageNo, 10, keyWords, selectedQuickMsgType)
    }

    function prePage() {
        var currPageNo = $("#pageNoData").val();
        var keyWords = $("#searchQuickMsgKeyWords").val();
        var prePageNo = (currPageNo - 1) < 1  ? 1 : (currPageNo - 1);
        selectQuickMsgPageList(prePageNo, 10, keyWords, selectedQuickMsgType)
    }

    function selectQuickMsgPageList(pageNo, pageSize, keyWords, quickMsgType) {
        pageNo = pageNo ? pageNo : 1;
        pageSize = pageSize ? pageSize : 10;
        quickMsgType = quickMsgType ? quickMsgType : 0;
        selectedQuickMsgType = quickMsgType;
        var quickMsgForm;
        if (keyWords) {
            quickMsgForm = {"pageNo": pageNo, "pageSize": pageSize, "quickMsgType": quickMsgType, "keyWords": keyWords};
        } else {
            quickMsgForm = {"pageNo": pageNo, "pageSize": pageSize, "quickMsgType": quickMsgType};
        }
        var url = basePath + "http://47.115.80.88:8082/cs/selectQuickMsgList";
        jQuery.post(url, quickMsgForm,
                function (data, textStatus){
                    if (data.resCode == 0) {
                        //更新页码
                        $("#pageNoSpan").html("第" + pageNo + "页");
                        var totalPage = Math.ceil(data.totalRecords / 10);
                        $("#pageNoData").val(pageNo);
                        $("#totalRecordsData").val(totalPage);

                        $("#totalRecordsSpan").html("共"+totalPage+"页");

                        var quickMsgHtml = '';
                        if (data.dataList.length == 0) {
                            if (quickMsgForm.quickMsgType){
                                quickMsgHtml += '<tr><td style="text-align: center;cursor: pointer; color: #C80000;" onclick="addTag()">+ 新增私有快捷信息</td></tr><tr><td>没有相关数据</td></tr>';
                            }else{
                                quickMsgHtml += '<tr><td>没有相关数据</td></tr>';
                            }
                        } else {
                            if (quickMsgForm.quickMsgType){
                                quickMsgHtml = '<tr><td style="text-align: center;cursor: pointer; color: #C80000;" onclick="addTag()">+ 新增私有快捷信息</td></tr>';
                            }
                            $.each(data.dataList, function (index, quickMsgData) {
                                var msgRemark = quickMsgData.msg_remark ? quickMsgData.msg_remark : quickMsgData.msg_content;
                                if(quickMsgData.msg_type == 1){
                                    quickMsgHtml += '<tr> <td class="quickTd" onclick="chooseQuickMsg(this)" title="'+msgRemark+'" data-type="' + quickMsgData.msg_type + '">'
                                           +'<span class="contentSpan">' + quickMsgData.msg_content + '</span>' ;
                                } else if(quickMsgData.msg_type == 2){
                                    quickMsgHtml += '<tr> <td class="quickTd" onclick="chooseQuickMsg(this, \''+quickMsgData.quick_msg_id+'\')"  title="'+msgRemark+'" data-type="' + quickMsgData.msg_type + '">'
                                            + '<img class="quickimg" src="' + quickMsgData.msg_content + '" />' +
                                            '<button class="quickbtn" onclick="preview(this)">'+'预览'+'</button>' ;
                                } else if(quickMsgData.msg_type == 3){
                                    quickMsgHtml += ' <tr> <td class="quickTd"  title="'+msgRemark+'" onclick="chooseQuickMsg(this, \''+quickMsgData.quick_msg_id+'\', \''+quickMsgData.msg_content+'\')" data-type="' + quickMsgData.msg_type + '">'
                                            + '<div class="lengthDiv" style="width:150px;height:39px;background:#9EEA6A;border-radius:4px;padding:3px 5px;" onclick="javascript:playVoice(this, \''+quickMsgData.msg_content+'\')"><div class="voiceBg" style="margin-top:5px;"></div></div>';

                                }
                                if (quickMsgData.msg_owner) {
                                    quickMsgHtml += '<div class="quickCancel" onclick="quickDelete('+quickMsgData.quick_msg_id+')"><i class="fa fa-remove" style="color:#C80000;"></i></div>';
                                }
                                quickMsgHtml +=  '</td></tr>';

                            });
                        }


                        $("#quickMsgTable").html(quickMsgHtml);
                    }else {
                        console.log("selectQuickMsgList" + data.resDesc);
                        //alert(data.resDesc);
                    }
                } , "json");

    }

    selectQuickMsgPageList(1, 10, null, 0)

    //显示快捷信息列表
    function showQuickMsgList() {
        checkMove = !checkMove;
        sideMove = false;
        var right;
        var divWidth = $('.quickMsg').width();

        selectQuickMsgPageList(1, 10, null, 0)

        if (checkMove) {
            right = '0';
        }else{
            right = '-'+divWidth + 'px';
        }
        $('.quickMsg').css('right',right);
        $('#doc-oc-demo3').offCanvas('close');
    }

    //选择快捷信息
    function chooseQuickMsg(doc, idx, audio) {
        var dataType = $(doc).attr('data-type');
        var uuid = guid();
        if(dataType == 2){
             $("#inputBox").append('<img data-idx="'+idx+'" class="customImg" style="max-height:200px;max-width:200px;" src="' + $(doc).find('img').attr('src') + '">');
        }else if(dataType == 1){

             $("#inputBox").append($(doc).find(".contentSpan").html());
            }else if(dataType == 3){
            if (confirm('确认发送？')) {

                showSendMsg(selectedWechat, selectedFriend, 3, 1, audio, uuid);
                var json = {"wxid": selectedWechat, "targetWxid" : selectedFriend , "msgType": 3, "quickMsgId": idx};
                jQuery.post( "http://47.115.80.88:8082/cs/sendMsg", json,
                    function (data, textStatus){
                        if (data.resCode == 0) {
                            //发送成功
                            $("#" + uuid).hide();
                        } else {
                            $("#" + uuid).removeClass("fa-spinner fa-pulse");
                            $("#" + uuid).addClass("fa-info-circle fa-rotate-180");
                            document.getElementById(uuid).style.color="red";
                            //alert(data.resDesc);
                            console.log("sendMsg" + data.resDesc);
                        }
                    } , "json")
            }
        }
    }

    //显示快捷信息
    function showQuickMsg(doc) {
        $(doc).attr("title", $(doc).find(".contentSpan").html());
    }

    // 快捷消息内容高度
    $('.quickTables').height($('.quickMsg').height()-136+'px');


    function doGetFriendInfoAndShow() {

        jQuery.post( "http://47.115.80.88:8082/cs/selectFriendInfo", {"wxid": selectedWechat, "targetWxid": selectedFriend},
                function (data, textStatus){
                    if (data.resCode == 0) {
                        //当好友信息为空时, 调用fresh操作
                        if (data.data == null || data.data.nickname == null || data.data.nickname == "") {
                            //重新获取数据
                            jQuery.post( "http://47.115.80.88:8082/cs/freshContactDetail", {"wxid": selectedWechat, "targetWxid": selectedFriend},
                                    function (data, textStatus){
                                        if (data.resCode == 0) {
                                            //当好友信息为空时, 调用fresh操作
                                            dealFriendData(data);
                                        } else {
                                            // alert(data.resDesc);
                                            console.log("freshContactDetail" + data.resDesc);
                                        }
                                    } , "json");

                        } else {
                            dealFriendData(data);
                        }
                    } else {
                        console.log("selectFriendInfo" + data.resDesc);
                        //alert(data.resDesc);
                    }
                } , "json");


        //查询出好友的标签列表
        jQuery.post( "http://47.115.80.88:8082/cs/getFriendLabels", {"wxid": selectedWechat, "targetWxid": selectedFriend},
                function (data, textStatus){
                    if (data.resCode == 0) {
                        var labelHtml = "";
                        $.each(data.dataList, function (index, friendLabel) {
                            labelHtml += '<div class="sigTag">'+friendLabel.labelName+'</div>'
                        })

                        $("#friendInfoTag").html(labelHtml);
                    } else {
                        console.log("getFriendLabels" + data.resDesc);
                        //alert(data.resDesc);
                    }
                } , "json");
    }

    function doGetChtRoomInfoAndShow() {
        showRoomInfo(selectedWechat, selectedFriend);
    }

    function showFriendData() {
        if (selectedFriend.indexOf("@chatroom") > -1) {
            doGetChtRoomInfoAndShow();
        } else {
            doGetFriendInfoAndShow();
        }

    }

    function dealFriendData(data) {
        $('#doc-oc-demo3').offCanvas('open');
        $("#friendInfoHead").attr("src", data.data.smallHeadPic);
        $("#friendInfoWxid").html((data.data.username == null || data.data.username == "" ) ? data.data.wxid : data.data.username );
        $("#friendInfoNickname").html(data.data.nickname);
        $("#updateRemarkNameWxid").val(data.data.wxid);
        $("#friendInfoMarkName").html('<div class="markinput" contenteditable="plaintext-only">'+data.data.remarkName+'</div>');
        $("#friendInfoSex").html(data.data.sex == 1 ? "男" : data.data.sex == 2 ? "女" : "保密" );
        $("#friendInfoProvince").html(parseProvince(data.data.province));
        $("#friendInfoCity").html(parseCity(data.data.province, data.data.city));
        $("#friendInfoSignature").html(data.data.gexinqianming);

        $("#labelIdsHidden").val(data.data.labelid);
    }

    //查询好友信息
    function selectFriendInfo() {
        if (!selectedFriend) {
            alert("请先选择好友");
        } else {
            var nowFriend = $("#updateRemarkNameWxid").val();
            sideMove = !sideMove;
            checkMove = false;

            if (!sideMove) {
                $('#doc-oc-demo3').offCanvas('close');
            }else{
                showFriendData();
                $('#doc-oc-demo3').offCanvas('open');
            }
            $('.quickMsg').css('right','0');
        }

    }


    // 快捷消息选择
    $('.checkspanBtn').on('click', function(){
        $('.checkspanBtn').removeClass('checkspanBtn-active');
        $('.checkspanBtn').find('span').removeClass('checkspan-active');
        $(this).addClass('checkspanBtn-active');
        $(this).find('span').addClass('checkspan-active');
    });

    // 快捷消息图片预览
    function preview(doc){
        window.event? window.event.cancelBubble = true : e.stopPropagation();
        $('.quickmask, .quickimgpreview').show();

        var previewsrc = $(doc).prev().attr('src');
        $('.previewimg').attr('src', previewsrc)
    }
    $('.quickmask').click(function(){
        $('.quickmask, .quickimgpreview').hide();
    });

    // 左侧收放
    $('.retract_span').click(function(){
        leftSideMove = !leftSideMove
        var right;
        if (!leftSideMove) {
            right = -220 + 'px';
            // checkUserGroup("msg");
            $("#si_msg").click();
            checkUserGroup("msg");
            $("#si_fd").hide();
            $("#si_room_list").hide()

            if($('#listBtn1').hasClass('listBtn-active')) selectWechatFriend(0);
            if($('#listBtn2').hasClass('listBtn-active')) selectWechatFriend(1);
        }else{
            selectAllWechat();
            $("#si_fd").show();
            $("#si_room_list").show();
            right = 0;
        }
        $('.wechat_list').css('right', right);
    });

    $('.talkRecordDiv').scrollTop(300);

    var recordBoxLength = 0;
    // 聊天记录
    function showChatRecords(checkNum){
        if (selectedFriend == null) {
            alert("请先选中需要查看的好友");
            return;
        }
        if (!checkNum && recordId) return;
        $('.chat_records').show();
        var targetClassName = selectedFriend.replace("@openim", "_openim");
        targetClassName = targetClassName.replace("@chatroom", "_chatroom");
        var headPic = $("#"+selectedWechat +targetClassName + " .user_head img")[0].outerHTML;
        var headImgSrc = $("#chatbox").find('.me').eq(0).find('img').attr("src");
        var talkListFrom = {};
        talkListFrom.wxid = selectedWechat;
        if (recordId) {
            talkListFrom.recordId = recordId;
        }
        var  talkUrl = "http://47.115.80.88:8082/cs/selectTalkList";
        if (selectedFriend.indexOf("@chatroom") > -1) {
            talkUrl = "http://47.115.80.88:8082/cs/selectRoomTalkList";
            talkListFrom.chatRoomId = selectedFriend;
        } else {
            talkListFrom.targetWxid = selectedFriend;
        }
        jQuery.post(talkUrl, talkListFrom,
        function (data, textStatus){
            if (data.resCode == 0) {
                var talkHtml = '';
                var _re;
                if (recordId) {
                    _re =1;
                }else{
                    _re =0;
                }

                $.each(data.dataList, function (index) {
                    var talkData = data.dataList[data.dataList.length - index - 1];
                    if (index == 0) {
                        recordId = talkData.record_id;
                    }
                    if (talkData.msg_content.indexOf("\n") > -1) {
                        var reg = new RegExp("\n","g");//g,表示全部替换。
                        talkData.msg_content = talkData.msg_content.replace(reg, "<br>");
                    }

                    if(talkData.msg_type == 10000){
                        talkHtml += '<li class="timer" style="margin: 10px 0;font-size: 12px; padding: 0 5px;line-height: 16px;">系统消息: ' + talkData.msg_content + '</li>'
                    }

                    if(talkData.target_type == 1){
                        //自己发出的消息
                        if(talkData.msg_type == 1){
                            talkHtml += '<li class="timer">' + moment(talkData.create_time).format("YYYY-MM-DD HH:mm:ss") + '</li><li class="me"><img style="width:34px;" src="'+ headImgSrc +'"/><span>'+replaceFace(talkData.msg_content) +'</span></li>';
                        }else if(talkData.msg_type == 2){
                            var talkMsg = talkData.msg_content;
                            if (talkMsg.indexOf("http://") == -1  && talkMsg.indexOf("base64") == -1) {
                                talkMsg = "data:image/jpeg;base64," + talkMsg;
                            }
                            talkHtml += '<li class="timer">' + moment(talkData.create_time).format("YYYY-MM-DD HH:mm:ss") + '</li><li class="me"><img style="width:34px;" src="'+ headImgSrc +'"/><img src="'+talkMsg+'" style="width:100px;height:100px;margin:0 10px;" onclick="showSendImg(this, \''+talkData.record_id+'\')" /></li>';
                        }else if(talkData.msg_type == 3){
                            talkHtml += '<li class="timer">' + moment(talkData.create_time).format("YYYY-MM-DD HH:mm:ss") + '</li><li class="me"><img style="width:34px;" src="'+ headImgSrc +'"/><div class="lengthDivMe" style="width:150px;height:39px;background:#9EEA6A;border-radius:4px;padding:3px 5px;margin-right:40px;" onclick="javascript:playVoice(this, \''+talkData.msg_content+'\')"><div class="voiceBg" style="margin-top:5px;"></div></div></li>';
                        } else if (talkData.msg_type == 4){
                            talkHtml += '<li class="timer">' +  moment(talkData.create_time).format("YYYY-MM-DD HH:mm:ss") + '</li>' +
                                    '<li class="me"><img style="width:34px;" src="'+ headImgSrc +'">';
                            talkHtml += '<span class="lengthDivMe">';
                            var obj=JSON.parse(talkData.msg_content);
                            var cardHead = basePath +"./static/img/defaultHeadPic.jpg"
                            var cardName = talkData.msg_content;
                            if(typeof obj == 'object' && obj ){
                                cardHead = obj.smallHeadImg;
                                cardName = obj.nickname;
                                if (cardName) {
                                    cardName = cardName ? cardName : "未知";
                                }
                                cardHead = cardHead ? cardHead :  (basePath +"./static/img/defaultHeadPic.jpg");
                            }

                            talkHtml += '<div style="width:200px;height:70px;border:1px gray solid;background-color:white;">' +
                                    '<div style="height:40px;width:100%;"><img src='+cardHead+' style="margin:2px;width:35px;height:35px;float:left;"><i style="margin-left:10px;padding-top:10px;">'+cardName+'</i></div>' +
                                    '<div style="width:100%;height:15px;border-top: #ccc 1px solid;padding-left:20px;font-size:12px;">个人名片</div>' +
                                    '</div>'
                            talkHtml +=    '</span></div>';
                        }
                    } else {
                        var msg_content = talkData.msg_content;
                        talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>';
                        var senderInfo = selectedRoomMemInfo.get(talkData.send_wxid);
                        var showSendName = talkData.send_wxid;
                        if (senderInfo) {
                            headPic = senderInfo.bigImgHead;
                            showSendName = senderInfo.nickName;
                            headPic = headPic ? headPic : (basePath +"./static/img/defaultHeadPic.jpg");
                        } else {
                            headPic = basePath +"./static/img/defaultHeadPic.jpg";
                        }
                        headPic = '<img src="'+headPic+'">'
                        if(talkData.msg_type == 1){
                            msg_content =  replaceFace(msg_content);
                            talkHtml +=  '<li class="other" >'+headPic+'<div style="width:400px;"><i>'+showSendName+'</i><br><span>'+msg_content+'</span></div>';

                        }else if(talkData.msg_type == 2){
                            if (msg_content.indexOf("http://") == -1 && msg_content.indexOf("base64") == -1) {
                                msg_content = "data:image/jpeg;base64," + msg_content;
                            }
                            talkHtml += '<li class="other">'+headPic+'' + '<div  style="width:400px;"><i>'+showSendName+'</i><br>' +
                                    '<img src="'+msg_content+'" style="width:100px;height:100px;margin:0 10px;" onclick="showSendImg(this, \''+talkData.record_id+'\')" /></div>';

                        }else if(talkData.msg_type == 3){
                            talkHtml += '<li class="other">'+headPic+'<i>'+showSendName+'</i><br><div class="lengthDiv" style="width:150px;height:39px;background:#9EEA6A;border-radius:4px;padding:3px 5px;margin-left:45px;" onclick="javascript:playVoice(this, \''+msg_content+'\')">' +
                                    '<div class="voiceBg" style="margin-top:5px;"></div></div>';
                        } else if (talkData.msg_type == 4){
                            talkHtml += '<li class="other">' + headPic +'<i>'+showSendName + '<br>';
                            talkHtml +=  '<span class="">' ;
                            var obj=JSON.parse(talkData.msg_content);
                            var cardHead = basePath +"./static/img/defaultHeadPic.jpg"
                            var cardName = talkData.msg_content;
                            if(typeof obj == 'object' && obj ){
                                cardHead = obj.smallHeadImg;
                                cardName = obj.nickname;
                                if (cardName) {
                                    cardName = cardName ? cardName : "未知";
                                }
                                cardHead = cardHead ? cardHead :  (basePath +"./static/img/defaultHeadPic.jpg");
                            }

                            talkHtml += '<div style="width:200px;height:70px;border:1px gray solid;background-color:white;">' +
                                    '<div style="height:40px;width:100%;"><img src='+cardHead+' style="margin:2px;width:35px;height:35px;float:left;"><i style="margin-left:10px;padding-top:10px;">'+cardName+'</i></div>' +
                                    '<div style="width:100%;height:15px;border-top: #ccc 1px solid;padding-left:20px;font-size:12px;">个人名片</div>' +
                                    '</div>'
                            talkHtml +=    '</span></div>';
                        }
                        talkHtml +=   '</li>';
                    }

                });

                if (data.dataList.length == 0){

                    if (_re) {
                        $("#chatboxs").prepend('<div style="width:100%;text-align:center">没有更多聊天记录</div>');
                        $('.loadMore').remove();
                    } else {
                        $("#chatboxs").html('<div style="width:100%;text-align:center">没有聊天记录</div>');
                    }

                }else{
                    if (_re) {
                        $('.loadMore').remove();
                        $("#chatboxs").prepend('<li class="loadMore" style="float:right;">----------上次阅读到这里----------</li>')
                        $("#chatboxs").prepend(talkHtml);
                        $("#chatboxs").prepend('<li class="loadMore" onclick="showChatRecords(1)" style="float:right;">加载更多...</li>')
                        var height = recordBoxLength - $("#chatboxs").height();
                        // $('#talkRecord').height()
                        $("#chatboxs").css({top:height+ "px"});
                    }else{
                        $("#chatboxs").html(talkHtml);
                        $("#chatboxs").prepend('<li class="loadMore" onclick="showChatRecords(1)" style="float:right;">加载更多...</li>')
                        if ($("#chatboxs").height() < $('#talkRecord').height()) {
                            $("#chatboxs").css('top',0);
                        }else{
                            var height = $('#talkRecord').height() - 20 - $("#chatboxs").height();
                            $("#chatboxs").css({top:height+ "px"});
                        }
                    }
                    recordBoxLength = $("#chatboxs").height();
                }
            } else {
                console.log("selectTalkList" + data.resDesc);
             //   alert(data.resDesc);
            }
        } , "json");
    }


    $(".chat_records").draggable();
    $('.records_closed').click(function(){
        recordId = null;
        $('.chat_records').hide();
    })

    // 查看聊天记录图片
    function showSendImg(doc, recordId){
        $('.quickmask, .quickimgpreview').show();
        $('.previewimg').attr('src', doc.src)

        if (recordId && doc.src.indexOf("http://") == -1) {
            //表示需要查询原图
            jQuery.post(basePath + "http://47.115.80.88:8082/cs/getOrginalImg", {"recordId": recordId},
                    function (data, textStatus){
                        if (data.resCode == 0) {
                            var imgUrl = data.data;
                            // $('.quickmask, .quickimgpreview').show();
                            if (imgUrl.indexOf("http://") == -1 && imgUrl.indexOf("base64") == -1) {
                                imgUrl = "data:image/jpeg;base64," + imgUrl;
                            }
                            $('.previewimg').attr('src', imgUrl)
                        } else {
                            console.log(data.resDesc);
                        }
                    } , "json")

        }

    }

    // 查看聊天记录图片
    function showRoomSendImg(doc, recordId){
        $('.quickmask, .quickimgpreview').show();
        $('.previewimg').attr('src', doc.src)

        if (recordId && doc.src.indexOf("http://") == -1) {
            //表示需要查询原图
            jQuery.post(basePath + "http://47.115.80.88:8082/cs/getRoomOrginalImg", {"recordId": recordId},
                    function (data, textStatus){
                        if (data.resCode == 0) {
                            var imgUrl = data.data;
                            // $('.quickmask, .quickimgpreview').show();
                            if (imgUrl.indexOf("http://") == -1 && imgUrl.indexOf("base64") == -1) {
                                imgUrl = "data:image/jpeg;base64," + imgUrl;
                            }
                            $('.previewimg').attr('src', imgUrl)
                        } else {
                            console.log(data.resDesc);
                        }
                    } , "json")

        }

    }
    
    // 绑定标签
    var selectedTagIds = [];
    $('#bd').click(function(){
        //getWechatTagList
        selectedTagIds = [];
        jQuery.post(basePath + "http://47.115.80.88:8082/cs/getWechatTagList", {"wxid": selectedWechat},
                function (data, textStatus){
                    if (data.resCode == 0) {
                        //<div class="tags_item">123</div>
                        //tags_text
                        if (data.dataList.length == 0) {
                            alert("该账号没有标签");
                        } else {
                            var tagsHtml = '';
                            var exlabelIds = $("#labelIdsHidden").val();
                            var labelIdList =exlabelIds.split(",");

                            $.each(data.dataList, function(index, wechatTag) {
                                //是否选择
                                var selectHtml = '';
                                if (labelIdList.indexOf(wechatTag.labelId+ '') > -1) {
                                    selectedTagIds.push(wechatTag.labelId);
                                    selectHtml = 'tags_active'
                                }

                                tagsHtml += '<div class="tags_item '+selectHtml+'" data-label-id="'+wechatTag.labelId+'" onclick="chooseWechatTag(this)">'+wechatTag.labelName+'</div>';
                            });
                            $(".tags_text").html(tagsHtml);
                        }

                        $('.tags').show();
                    } else {
                        console.log("getWechatTagList" + data.resDesc);
                        //alert(data.resDesc);
                    }
                } , "json")


    });
    $('.tags_closed').click(function(){
        $('.tags_item').removeClass('tags_active');
        $('.tags').hide();
    });
    function chooseWechatTag(doc, labelId) {
        $(doc).toggleClass('tags_active');
    }

    $('.tags_cancel').click(function(){
        $('.tags_item').removeClass('tags_active');
    });



    // 常用好友消息类型切换
    $('.listBtn').click(function(){
        $('.listBtn').removeClass('listBtn-active');
        $('.listBtn span').removeClass('wx_change_span_active')
        $(this).addClass('listBtn-active');
        $(this).find('span').addClass('wx_change_span_active');
    });

    // 发送快捷键
    function keySend(evt){
        if(!event.altKey && event.keyCode == 13){
            event.preventDefault();
            sender();
        }
        if(event.altKey && event.keyCode == 13){
            event.preventDefault();


            add();
            // $("#inputBox").focus();
        }
    }

    function add(){
        //添加换行
        insertHTML("<div><br/></div>");
    }


    function insertHTML(html)
    {
        var sel, range;
        if (window.getSelection)
        {
            sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                range = sel.getRangeAt(0);
                range.deleteContents();
                var el = document.createElement('div');
                el.innerHTML = html;
                var frag = document.createDocumentFragment(), node, lastNode;
                while ( (node = el.firstChild) ) {
                    lastNode = frag.appendChild(node);
                }
                range.insertNode(frag);
                if (lastNode) {
                    range = range.cloneRange();
                    range.setStartAfter(lastNode);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
        }
        else if (document.selection && document.selection.type !='Control')
        {
            var ierange= document.selection.createRange();//获取光标位置    
            ierange.pasteHTML(html);    //在光标位置插入html 如果只是插入text 则就是fus.text="..."    
        }
    }


    // 快捷信息删除
    function quickDelete(quickMsgId){
        window.event? window.event.cancelBubble = true : e.stopPropagation();
           if(confirm("确认删除此快捷信息?")) {
               jQuery.post(basePath + "http://47.115.80.88:8082/cs/delQuickMsg", {"quickMsgId": quickMsgId},
                       function (data, textStatus){
                           if (data.resCode == 0) {
                               alert("删除成功");
                               var keyWords = $("#searchQuickMsgKeyWords").val();
                               selectQuickMsgPageList(1, 10, keyWords, 1)
                           } else {
                               alert(data.resDesc);
                           }
                       } , "json")

           }
    }

    // 转到第几页回车事件
    function goToPage(){
        var pageNo = $("#pageNoInput").val();
        var keyWords = $("#searchQuickMsgKeyWords").val();

        selectQuickMsgPageList(pageNo, 10, keyWords, selectedQuickMsgType)
    }

    // 新增标签
    function addTag() {
        $('.newTag-mask, .newTag').show();
    }

    // 新增标签类型选择
    $('.newTag-head-item').click(function(){
        $('.newTag-head-item').removeClass('newTag-head-item-active');
        $(this).addClass('newTag-head-item-active');
        for (var i = $('.newTag-content-item').length - 1; i >= 0; i--) {
            if ($(this).index() == $('.newTag-content-item').eq(i).attr('data-x')) {
                $('.newTag-content-item').eq(i).show();
            }else{
                $('.newTag-content-item').eq(i).hide();
            }
        }
    });

    // 新增标签图片,语音上传
    function inputTagImg(doc) {
        if($(doc)[0].files[0] != null && $(doc)[0].files[0] != undefined) {
            $(doc)[0].files[0];
            var freader = new FileReader();
            freader.readAsDataURL($(doc)[0].files[0]);
            if ($(doc)[0].files[0].type != 'audio/mp3') {
                freader.onload = function(e){
                    $(".newTag-img-preview").html('<img style="width:196px;height:196px" src="'+e.target.result+'">');
                };
            }    
        }
    }

    // 新增标签确认和取消
    $('.newTag-btn-cancel').click(function(){
        $('.newTag-mask, .newTag').hide();
    });
    $('#newTag-btn-confirm').click(function(){
        var contentId;
        for (var i = $('.newTag-content-item').length - 1; i >= 0; i--) {
            if ($('.newTag-content-item').eq(i).css('display') == 'block') {
                contentId = $('.newTag-content-item').eq(i).attr('data-x')
            }
        }
        $(".loadingDiv").show();
        var msgRemark = $("#msgRemark").val();
        if (contentId == 0) {
            var msgContent = $('.newTag-text').val();
            var formData = {};
            formData.msgType = 1;
            formData.msgContent = msgContent;
            if (msgRemark) {
                formData.msgRemark = msgRemark;
            }

            jQuery.post(basePath + "http://47.115.80.88:8082/cs/addQuickMsg", formData,
                    function (data, textStatus){
                        $(".loadingDiv").hide();
                        if (data.resCode == 0) {
                            $('.newTag-mask, .newTag').hide();
                           alert("添加成功");

                            var keyWords = $("#searchQuickMsgKeyWords").val();
                            selectQuickMsgPageList(1, 10, keyWords, selectedQuickMsgType)
                        } else {
                            alert(data.resDesc);
                        }
                    } , "json")

        }else {
            var formData = new FormData();

            if (contentId == 1) {
                formData.append("msgType", 2);
                formData.append("msgFile", $('input[name="fileImg"]')[0].files[0]);
            } else  if (contentId == 2) {
                formData.append("msgType", 3);
                formData.append("msgFile", $('input[name="fileAudio"]')[0].files[0]);
            }

            if (msgRemark) {
                formData.append("msgRemark", msgRemark);
            }

            $.ajax({
                url: basePath + "http://47.115.80.88:8082/cs/addQuickMsg",
                type: "post",
                data: formData,
                contentType: false,
                processData: false,
                mimeType: "multipart/form-data",
                success: function (data) {
                    $(".loadingDiv").hide();
                    data = $.parseJSON(data);
                    if (data.resCode == 0) {
                        $('.newTag-mask, .newTag').hide();
                        alert("添加成功");
                        var keyWords = $("#searchQuickMsgKeyWords").val();
                        selectQuickMsgPageList(1, 10, keyWords, selectedQuickMsgType)
                    } else {
                        alert(data.resDesc);
                    }
                },
                error: function (data) {
                    $(".loadingDiv").hide();
                }
            });

        }
    });


    /**
     * 修改备注
     */
    function updateRemarkName() {
        var targetWxid = $("#updateRemarkNameWxid").val();
        var wxid = selectedWechat;
        var newName = $(".markinput").html();
        if (newName.length > 30) {
            alert("备注名太长");
        } else {
            $(".loadingDiv").show();
            jQuery.post(basePath + "http://47.115.80.88:8082/cs/updateFriendRemarkName", {"wxid": wxid, "targetWxid" : targetWxid, "newName":newName},
                    function (data, textStatus){
                        $(".loadingDiv").hide();
                        if (data.resCode == 0) {
                            alert("修改成功");
                        } else {
                            alert(data.resDesc);
                        }
                    } , "json")
        }


    }

    function bindFriendTag() {
        var targetWxid = $("#updateRemarkNameWxid").val();
        var wxid = selectedWechat;
        var selectedTags = $(".tags_active");
        var labelids = [];
        $.each(selectedTags, function(index, tagId){
            labelids.push($(tagId).attr("data-label-id"));
        })
        if (labelids.length == 0) {
            alert("请选择至少一个标签");
        } else {
            $(".loadingDiv").show();
            var tagIds = labelids.join(",");
            jQuery.post(basePath + "http://47.115.80.88:8082/cs/bindTag", {"wxid": wxid, "targetWxid" : targetWxid, "tagIds":tagIds, "bindType":0},
                    function (data, textStatus){
                        $(".loadingDiv").hide();
                        if (data.resCode == 0) {
                            $('.tags').hide();
                            alert("绑定成功");
                        } else {
                            alert(data.resDesc);
                        }
                    } , "json")
        }
    }


    // 显示/关闭特别关心
    function showCare() {
        if (!careWechatId){
            alert('请选择好友');
            return false;
        }
        $('.care, .care-mask').show();
        $('.care-title').html($('#currentFriendName').html());
        getCareList();
    }
    $('.care-foot-cancel').click(function() {
        getCareList(null, 'care');
        $('.care, .care-mask').hide();
    })
    $('.care-set-add').click(function () {
        $('.care').hide();
        $('.addCare').show();
    })
    $('.care-set-del').click(function () {
        $('.care').hide();
        $('.delCare').show();
        getCareList(1);
    })
    $('.addCare-foot-cancel').click(function () {
        $('.care').show();
        $('.addCare').hide();
    })
    $('.delCare-foot-cancel').click(function () {
        $('.care').show();
        $('.delCare').hide();
        getCareList();
    })

    /**
     * 获取特别关心列表
     */
    function  getCareList(del, care) {
        jQuery.post(basePath + "http://47.115.80.88:8082/cs/getCareList",
                function (data, textStatus){
                    if (data.resCode == 0) {
                        var option = '';
                        var careOption = '<option value="unselected" disabled hidden selected>请选择分组</option><option value="">全部</option>';
                        var dataDelList = [];
                        var dataCareList = [];
                        if(del){
                            for(var i=0; i<data.dataList.length; i++){
                                if(data.dataList[i].careName == '默认' || data.dataList[i].careName == '无特别关心') continue;
                                dataDelList.push(data.dataList[i]);
                            }
                            for(var i=0; i<dataDelList.length; i++){
                                option +='<option value="'+dataDelList[i].careId+'">'+dataDelList[i].careName+'</option>';
                            }
                        }else if(care){
                            for(var i=0; i<data.dataList.length; i++){
                                if(data.dataList[i].careName == '无特别关心') continue;
                                dataCareList.push(data.dataList[i]);
                            }
                            for(var i=0; i<dataCareList.length; i++){
                                careOption +='<option value="'+dataCareList[i].careId+'">'+dataCareList[i].careName+'</option>';
                            }
                        }else{
                            for(var i=0; i<data.dataList.length; i++){
                                option +='<option value="'+data.dataList[i].careId+'">'+data.dataList[i].careName+'</option>';
                            }
                        }
                        $('.care-select').html(option);
                        $('.care-select-list').html(careOption);
                        $('.delCare-select').html(option);
                    } else {
                        alert(data.resDesc);
                    }
                } , "json")
    }



    /**
     * 添加特别关心分组
     */
    $('.addCare-foot-confirm').click(function () {
        if(!$('.addCare-input').val()){
            alert('名称不能为空');
            return false;
        }else{
            addCare($('.addCare-input').val());
        }
    })
    function addCare(careName) {
        jQuery.post(basePath + "http://47.115.80.88:8082/cs/addCare", {"careName": careName},
                function (data, textStatus){
                    if (data.resCode == 0) {
                        $('.care').show();
                        $('.addCare').hide();
                        getCareList();
                    } else {
                        alert(data.resDesc);
                    }
                } , "json")
    }

    /**
     * 删除特别关心分组
     */
    $('.delCare-foot-confirm').click(function () {
        delCare($(".delCare-select option:selected").val());
    })
    function delCare(careId) {
        //需要传递的
       if (confirm("确定删除此分组?")) {
           jQuery.post(basePath + "http://47.115.80.88:8082/cs/delCare", {"careId": careId},
                   function (data, textStatus){
                       if (data.resCode == 0) {
                           $('.care').show();
                           $('.delCare').hide();
                           getCareList();
                       } else {
                           alert(data.resDesc);
                       }
                   } , "json")
       }
    }

    /**
     * 绑定特别关心分组, 如果是取消绑定, 则传-1, 没有分组, 传0
     */
    $('.care-foot-confirm').click(function() {
        bindCareList($(".care-select option:selected").val(), selectedWechat, selectedFriend);
    })
    function bindCareList(careId, wxid, targetWxid) {
        jQuery.post(basePath + "http://47.115.80.88:8082/cs/bindCareFriend", {"careId": careId, "wxid": wxid, "targetWxid": targetWxid},
                function (data, textStatus){
                    if (data.resCode == 0) {
                        if(careId == -1){
                            $('.care-un').show();
                            $('.care-ed').hide();
                        }else{
                            $('.care-un').hide();
                            $('.care-ed').show();
                        }
                        //修改参数
                        var targetClassName = targetWxid.replace("@openim", "_openim");
                        $("#" + wxid + targetClassName).attr("onclick", "chooseFriend('"+wxid+"','" + targetWxid+ "', '"+careId+"')");
                        $('.care, .care-mask').hide();

                    } else {
                        alert(data.resDesc);
                    }
                } , "json")
    }


    // 获取特别关心好友列表
    function selectFriendByCare(careId) {
        jQuery.post(basePath + "http://47.115.80.88:8082/cs/selectFriendByCare", {"careId": careId},
                function (data, textStatus){
                    if (data.resCode == 0) {
                        var dataList =  data.dataList;
                        var serviceHtml = '';
                        if (dataList.length == 0) {
                            $("#allMarkFriendList").html('<li id="noFriendDataLi">没有数据</li>');
                        } else {
                            $.each(dataList, function (index, fdata) {
                                var friendHead = fdata.bigHeadPic;
                                friendHead = friendHead ? friendHead : (basePath + "./static/img/defaultHeadPic.jpg");
                                var showName = (fdata.remarkName == null || fdata.remarkName == "") ? fdata.nickname : fdata.remarkName;
                                var remark = fdata.remark;
                                var showTime = fdata.lastTalkTime == null ? "" :  moment(new Date(fdata.lastTalkTime)).format('YYYY-MM-DD HH:mm:ss');
                                var targetClassName = fdata.targetWxid.replace("@openim", "_openim");

                                serviceHtml += '<li onclick="chooseFriend(\''+fdata.wxid+'\', \'' + fdata.targetWxid+ '\', \'' + fdata.careId+ '\')"  id="'+fdata.wxid + targetClassName+'" data-name="'+fdata.nickname+fdata.remarkName+'">' +
                                        '<div class="user_head"><img src="'+friendHead+'"/>';

                                var showOrHide = '';
                                if (!fdata.noReadNum) {
                                    showOrHide='display:none;';
                                }

                                serviceHtml += '<div class="msgNums" style="top:-10px;left:28px;'+showOrHide+'">'+fdata.noReadNum+'</div>\n';
                                serviceHtml+='</div><div class="user_text">\n' +
                                        '<p class="user_name">'+showName+'</p>\n' +
                                        ' <p class="user_message">'+remark+'</p>\n' +
                                        ' </div>\n' +
                                        '<div class="user_time">'+showTime+'</div>\n' +
                                        '  </li>';
                            });
                            $("#allMarkFriendList").html(serviceHtml);
                        }
                    } else {
                        alert(data.resDesc);
                    }
                } , "json")
    }

    // 聊天列表本地搜索
    function searchLocalFriend() {
        for (var i=0; i<$('#serviceFriendList li').length; i++){
            if(!$('#wx_search_input').val()){
                $('#serviceFriendList li').eq(i).show();
            }else{
                $('#serviceFriendList li').eq(i).hide();
                if($('#serviceFriendList li').eq(i).attr('data-name').indexOf($('#wx_search_input').val()) != -1){
                    $('#serviceFriendList li').eq(i).show();
                }
            }
        }
    }
    function searchLocalFriends() {
        for (var i=0; i<$('#allFriendList li').length; i++){
            if(!$('#tset').val()){
                $('#allFriendList li').eq(i).show();
            }else{
                $('#allFriendList li').eq(i).hide();
                if($('#allFriendList li').eq(i).attr('data-name').indexOf($('#tset').val()) != -1){
                    $('#allFriendList li').eq(i).show();
                }
            }
        }
    }
    function searchInputCareFriend() {
        for (var i=0; i<$('#allMarkFriendList li').length; i++){
            if(!$('#care_input').val()){
                $('#allMarkFriendList li').eq(i).show();
            }else{
                $('#allMarkFriendList li').eq(i).hide();
                if($('#allMarkFriendList li').eq(i).attr('data-name').indexOf($('#care_input').val()) != -1){
                    $('#allMarkFriendList li').eq(i).show();
                }
            }
        }
    }
    function searchSelectCareFriend() {
        if($(".care-select-list option:selected").val() == 'unselected'){
            alert('请选择分组');
            return false;
        }
        selectFriendByCare($(".care-select-list option:selected").val());
    }


    function  searchWxRoom() {
        for (var i=0; i<$('#talkingRoomList li').length; i++){
            if(!$('#room_search_input').val()){
                $('#talkingRoomList li').eq(i).show();
            }else{
                $('#talkingRoomList li').eq(i).hide();
                console.log($('#room_search_input').val());
                var searchname = $('#room_search_input').val();
                searchname = searchname.replace("@", "_");
                console.log($('#talkingRoomList li').eq(i).attr('data-name'));
                console.log($('#room_search_input').val());;
                if($('#talkingRoomList li').eq(i).attr('data-name').indexOf(searchname) != -1){
                    $('#talkingRoomList li').eq(i).show();
                    console.log("searchData");
                }
            }
        }
    }

    /**
     * 查询出聊天中的群列表
     * @param readStatus
     */
    function selectTalkingRoomList(readStatus) {
        readStatus = readStatus ? readStatus : 0;
        selectedReadStatus = readStatus;
        var searchUrl = "http://47.115.80.88:8082/cs/selectServiceRoomList?readStatus=" + readStatus;
        var isAdd = false;
        if (lastQueryRoomTime) {
            isAdd = true;
            console.log(lastQueryRoomTime + "+lastQueryTime")
            searchUrl += "&lastQueryTime=" + lastQueryRoomTime;
        } else {
            $("#serviceFriendList").html('<li>数据加载中...</li>');
        }

        jQuery.post(searchUrl,
                function (data, textStatus){
                    if (data.resCode == 0) {
                        var dataList =  data.dataList;
                        var serviceHtml = '';
                        if (dataList.length == 0) {
                            if (isAdd) {
                                $("#talkingRoomList").append('<li id="noRoomDataLi">没有更多数据</li>');
                                $("#getMoreWxRoomBtn").hide();
                            } else {
                                $("#talkingRoomList").html('<li id="noRoomDataLi">没有数据</li>');
                                $("#getMoreWxRoomBtn").hide();
                            }

                        } else {
                            $.each(dataList, function (index, fdata) {
                                if (index == 199) {
                                    lastQueryRoomTime = fdata.last_talk_time;
                                    $("#getMoreWxRoomBtn").show();
                                } else {
                                    $("#getMoreWxRoomBtn").hide();
                                }
                                var friendHead = fdata.smallHeadPic;
                                friendHead = friendHead ? friendHead : (basePath + "./static/img/defaultHeadPic.jpg");
                                var showName = (fdata.roomName == null ? "" : fdata.roomName ) + "(" + fdata.target_wxid + ")";


                                var showTime = fdata.last_talk_time == null ? "" :  moment(new Date(fdata.last_talk_time)).format('YYYY-MM-DD HH:mm:ss');
                                var targetClassName = fdata.target_wxid.replace("@chatroom", "_chatroom");
                                serviceHtml += '<li onclick="chooseChatRoom(\''+fdata.wxid+'\', \'' + fdata.target_wxid+ '\')"  id="'+fdata.wxid + targetClassName+'" data-name="'+fdata.roomName+targetClassName+'">' +
                                        '<div class="user_head"><img src="'+friendHead+'"/>';

                                var showOrHide = '';
                                if (fdata.no_read_num  == 0) {
                                    showOrHide='display:none;';
                                }

                                serviceHtml += '<div class="msgNums" style="top:-10px;left:28px;'+showOrHide+'">'+fdata.no_read_num+'</div>\n';
                                serviceHtml+='</div><div class="user_text">\n' +
                                        '<p class="user_name">'+showName+'</p>\n' +
                                        ' <p class="user_time">'+showTime+'</p>\n' +
                                        ' </div>\n' +
                                        '  </li>';
                            });
                            if (isAdd) {
                                $("#talkingRoomList").append(serviceHtml);
                            } else {
                                $("#talkingRoomList").html(serviceHtml);
                            }

                        }

                    } else {
                        console.log("selectServiceRoomList" + data.resDesc);
                        //alert(data.resDesc);
                    }
                } , "json")

    }





    function chooseChatRoom(wxid, wxRoomId) {
        $("#friendInfoTable").hide();
        $("#chatRoomInfoTable").show();
        selectedFriend = wxRoomId;
        selectedWechat = wxid;

        $("#allRoomList .active").removeClass("active");
        $("#wechatListDiv a").removeClass('active')
        $("#wechat_" + selectedWechat).addClass("active")
        var targetClassName = wxRoomId.replace("@chatroom", "_chatroom")
        var fname = $("#" + wxid +targetClassName + " .user_name").html();
        $('#inputBox').focus();
        $("#careBtnDiv").hide();

        //TODO 查询出好友与本人的聊天记录
        // var wxid = selectedWechat;
        //查询聊天记录
        var headPic = $("#" +wxid + targetClassName  + " .user_head img")[0].outerHTML;
        var headImgSrc;
        selectedRoomMemInfo.clear();
        // getRoomMemList(wxid, wxRoomId);
        jQuery.post( "http://47.115.80.88:8082/cs/getWechatInfo?wxid=" + wxid,
                function (data, textStatus){
                    if (data.resCode == 0) {
                        var wechatInfo = data.data;
                        sendHeaderImg = wechatInfo.bigHeadPic;
                        sendHeaderImg = sendHeaderImg ? sendHeaderImg : (basePath +"./static/img/defaultHeadPic.jpg");
                        $("#currentFriendName").html(wechatInfo.nickname + '('+wxid+')的群聊:' +fname);
                        headImgSrc = wechatInfo.bigHeadPic;
                        headImgSrc = headImgSrc ? headImgSrc :(basePath +"./static/img/defaultHeadPic.jpg");
                        jQuery.post(basePath + "http://47.115.80.88:8082/cs/getChatRoomMemList", {"wxid":wxid, "wxRoomId":wxRoomId},
                                function (data, textStatus){
                                    var tableHtml = "";
                                    if (data.resCode == 0) {
                                        var dataList = data.dataList;

                                        $.each(dataList, function(index, roomMem) {
                                            var  memInfo = {};
                                            memInfo.sendWxid = roomMem.memWxid;
                                            memInfo.bigImgHead = roomMem.bigImgHead;
                                            memInfo.nickName = roomMem.nickName;
                                            selectedRoomMemInfo.set(roomMem.memWxid, memInfo);
                                            tableHtml += "<tr>";
                                            tableHtml += "<td>";
                                            tableHtml += "<img src='"+roomMem.bigImgHead+"' style='width:30px;height:30px;'>"
                                            tableHtml += "<span style='font-size:10px;'>"+roomMem.nickName+"("  + roomMem.memWxid+")</span>";
                                            tableHtml += "</td>";
                                            tableHtml += "</tr>";
                                        });


                                        jQuery.post( "http://47.115.80.88:8082/cs/selectRoomTalkList", {"wxid": wxid, "chatRoomId": wxRoomId},
                                                function (data, textStatus){
                                                    if (data.resCode == 0) {
                                                        var nums = $("#wechat_" + wxid + " .msgNums").html();

                                                        var fnum =$("#" +wxid + targetClassName + " .msgNums").html();

                                                        $("#wechat_" + wxid + " .msgNums").html(parseInt(nums) - parseInt(fnum));
                                                        if (parseInt(fnum) >= parseInt(nums)) {
                                                            $("#wechat_" + wxid + " .msgNums").hide();
                                                        }
                                                        $("#" +wxid + targetClassName+ " .msgNums").html(0);
                                                        $("#" +wxid + targetClassName + " .msgNums").hide();

                                                        var talkHtml = '';
                                                        $.each(data.dataList, function (index) {
                                                            var talkData = data.dataList[data.dataList.length - index - 1];
                                                            var msg_content = talkData.msg_content;
                                                            if (msg_content.indexOf("\n") > -1) {
                                                                var reg = new RegExp("\n","g");//g,表示全部替换。
                                                                msg_content = msg_content.replace(reg, "<br>");
                                                            }

                                                            if(talkData.msg_type == 10000){
                                                                talkHtml+= '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>'
                                                                talkHtml += '<li class="timer" style="margin: 10px 0;font-size: 12px; padding: 0 5px;line-height: 16px;">系统消息: ' + talkData.msg_content + '</li>'
                                                            }

                                                            if(talkData.target_type == 1) {
                                                                //自己发出的消息
                                                                if(talkData.msg_type == 1){
                                                                    msg_content =  replaceFace(msg_content);
                                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                                            '<li class="me">' +
                                                                            '<img style="width:34px;" src="'+ headImgSrc +'"/>' +
                                                                            '<span>'+msg_content+'</span>' +
                                                                            '</li>';
                                                                }else if(talkData.msg_type == 2){
                                                                    if (msg_content.indexOf("http://") == -1 && msg_content.indexOf("base64") == -1) {
                                                                        msg_content = "data:image/jpeg;base64," + msg_content;
                                                                    }
                                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                                            '<li class="me"><img style="width:34px;" src="'+ headImgSrc +'"/>' +
                                                                            '<img src="'+msg_content+'" style="width:100px;height:100px;margin:0 10px;" onclick="showRoomSendImg(this, \''+talkData.record_id+'\')" />' +
                                                                            '</li>';
                                                                }else if(talkData.msg_type == 3){
                                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                                            '<li class="me"><img style="width:34px;" src="'+ headImgSrc +'"/><div class="lengthDivMe" style="width:150px;height:39px;background:#9EEA6A;border-radius:4px;padding:3px 5px;margin-right:40px;" onclick="javascript:playVoice(this, \''+msg_content+'\')"><div class="voiceBg" style="margin-top:5px;"></div></div>' +
                                                                            '</li>';
                                                                } else if (talkData.msg_type == 4){
                                                                    talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>' +
                                                                            '<li class="me"><img style="width:34px;" src="'+ headImgSrc +'">';
                                                                    talkHtml += '<span class="lengthDivMe">';
                                                                    var obj=JSON.parse(msg_content);
                                                                    var cardHead = basePath +"./static/img/defaultHeadPic.jpg"
                                                                    var cardName = msg_content;
                                                                    if(typeof obj == 'object' && obj ){
                                                                        cardHead = obj.smallHeadImg;
                                                                        cardName = obj.nickname;
                                                                        if (cardName) {
                                                                            cardName = cardName ? cardName : "未知";
                                                                        }
                                                                        cardHead = cardHead ? cardHead :  (basePath +"./static/img/defaultHeadPic.jpg");
                                                                    }

                                                                    talkHtml += '<div style="width:200px;height:70px;border:1px gray solid;background-color:white;">' +
                                                                            '<div style="height:40px;width:100%;"><img src='+cardHead+' style="margin:2px;width:35px;height:35px;float:left;"><i style="margin-left:10px;padding-top:10px;">'+cardName+'</i></div>' +
                                                                            '<div style="width:100%;height:15px;border-top: #ccc 1px solid;padding-left:20px;font-size:12px;">个人名片</div>' +
                                                                            '</div>'
                                                                    talkHtml +=    '</span></div></li>';
                                                                }
                                                            } else {
                                                                talkHtml += '<li class="timer">' + moment(talkData.create_time).format('YYYY-MM-DD HH:mm:ss') + '</li>';
                                                                var senderInfo = selectedRoomMemInfo.get(talkData.send_wxid);
                                                                var showSendName = talkData.send_wxid;
                                                                if (senderInfo) {
                                                                    headPic = senderInfo.bigImgHead;
                                                                    showSendName = senderInfo.nickName;
                                                                    headPic = headPic ? headPic : (basePath +"./static/img/defaultHeadPic.jpg");
                                                                } else {
                                                                    headPic = basePath +"./static/img/defaultHeadPic.jpg";
                                                                }
                                                                headPic = headPic ? headPic : (basePath +"./static/img/defaultHeadPic.jpg");
                                                                headPic = '<img src="'+headPic+'">'
                                                                if(talkData.msg_type == 1){
                                                                    msg_content =  replaceFace(msg_content);
                                                                    talkHtml +=  '<li class="other" >'+headPic+'<div><i>'+showSendName+'</i><br><span>'+msg_content+'</span></div>';

                                                                }else if(talkData.msg_type == 2){
                                                                    if (msg_content.indexOf("http://") == -1 && msg_content.indexOf("base64") == -1) {
                                                                        msg_content = "data:image/jpeg;base64," + msg_content;
                                                                    }
                                                                    talkHtml += '<li class="other">'+headPic+'' + '<div><i>'+showSendName+'</i><br>' +
                                                                            '<img src="'+msg_content+'" style="width:100px;height:100px;margin:0 10px;" onclick="showSendImg(this, \''+talkData.record_id+'\')" /></div>';

                                                                }else if(talkData.msg_type == 3){
                                                                    talkHtml += '<li class="other">'+headPic+'<i>'+showSendName+'</i><br><div class="lengthDiv" style="width:150px;height:39px;background:#9EEA6A;border-radius:4px;padding:3px 5px;margin-left:45px;" onclick="javascript:playVoice(this, \''+msg_content+'\')">' +
                                                                            '<div class="voiceBg" style="margin-top:5px;"></div></div>';
                                                                } else if (talkData.msg_type == 4) {
                                                                    talkHtml += '<li class="other">'+headPic+'<div><i>'+showSendName+'</i><br>'
                                                                    talkHtml += '<span class="">';
                                                                    var obj = JSON.parse(msg_content);
                                                                    var cardHead = basePath + "./static/img/defaultHeadPic.jpg"
                                                                    var cardName = msg_content;
                                                                    if (typeof obj == 'object' && obj) {
                                                                        cardHead = obj.smallHeadImg;
                                                                        cardName = obj.nickname;
                                                                        if (cardName) {
                                                                            cardName = cardName ? cardName : "未知";
                                                                        }
                                                                        cardHead = cardHead ? cardHead : (basePath + "./static/img/defaultHeadPic.jpg");
                                                                    }

                                                                    talkHtml += '<div style="width:200px;height:70px;border:1px gray solid;background-color:white;">' +
                                                                            '<div style="height:40px;width:100%;"><img src=' + cardHead + ' style="margin:2px;width:35px;height:35px;float:left;"><i style="margin-left:10px;padding-top:10px;">' + cardName + '</i></div>' +
                                                                            '<div style="width:100%;height:15px;border-top: #ccc 1px solid;padding-left:20px;font-size:12px;">个人名片</div>' +
                                                                            '</div>'
                                                                    talkHtml += '</span></div>';
                                                                }
                                                                talkHtml +=   '</li>';
                                                            }
                                                        });
                                                        $("#msgBody .content").html(talkHtml);
                                                        // $("#chatbox").css({bottom:0});

                                                        if ($('#msgBody .office_text').height() > $("#chatbox").height()) {
                                                            $("#chatbox").css({top:0});
                                                        }else{
                                                            var height = $('#msgBody .office_text').height() - 20 - $("#chatbox").height();
                                                            $("#chatbox").css({top:height+ "px"})
                                                        }

                                                    } else {
                                                        console.log("selectTalkList" + data.resDesc);
                                                        // alert(data.resDesc);
                                                    }
                                                } , "json")


                                    } else {
                                        selectedRoomMemInfo.clear();
                                        tableHtml = "<tr><td>获取失败"+resDesc+"</td></tr>"
                                    }
                                    $("#roomMemTable").html(tableHtml);
                                } , "json");



                    } else {
                        console.log("getWechatInfo" + data.resDesc);
                        //alert(data.resDesc);
                    }
                } , "json")

        if (sideMove) {
            //TODO
            showRoomInfo(wxid, wxRoomId);
        }
    }




    function getRoomMemList(wxid, wxRoomId) {
        jQuery.post(basePath + "http://47.115.80.88:8082/cs/getChatRoomMemList", {"wxid":wxid, "wxRoomId":wxRoomId},
                function (data, textStatus){
                    var tableHtml = "";
                  if (data.resCode == 0) {
                      var dataList = data.dataList;
                      $.each(dataList, function(index, roomMem) {
                          var  memInfo = {};
                          memInfo.sendWxid = roomMem.memWxid;
                          memInfo.bigImgHead = roomMem.bigImgHead;
                          memInfo.nickName = roomMem.nickName;
                          selectedRoomMemInfo.set(roomMem.memWxid, memInfo);
                          tableHtml += "<tr>";
                          tableHtml += "<td>";

                          tableHtml += "<img src='"+roomMem.bigImgHead+"' style='width:30px;height:30px;'>"
                          tableHtml += "<span style='font-size:10px;'>"+roomMem.nickName+"("  + roomMem.memWxid+")</span>";
                          tableHtml += "</td>";
                          tableHtml += "</tr>";
                      });

                  } else {
                      selectedRoomMemInfo.clear();
                        tableHtml = "<tr><td>获取失败"+resDesc+"</td></tr>"
                  }
                  $("#roomMemTable").html(tableHtml);
                } , "json");
    }

    function showRoomInfo(wxid, wxRoomId) {
        jQuery.post(basePath + "http://47.115.80.88:8082/cs/selectChatRoomInfo", {"wxid":wxid, "wxRoomId":wxRoomId},
                function (data, textStatus){
                    console.log("roomInfo=" + data);
                    if (data.resCode == 0) {
                        $('#doc-oc-demo3').offCanvas('open');
                        $("#chatRoomHeadImg").attr("src", data.data.smallHeadPic);
                        $("#chatRoomIdTd").html(data.data.wxRoomId);
                        $("#chatRoomNameTd").html(data.data.roomName);
                        $("#chatRoomMemCount").html(data.data.memCount);

                    } else {
                        console.log(data.resDesc);
                    }
                } , "json");
    }


    var allRoomList = [];
    //查询出微信的所有好友
    function selectAllRoomList() {
        if  (!selectedWechat) {
            alert("请选择账号!");
        } else {
            var wxid = selectedWechat;
            jQuery.post( "http://47.115.80.88:8082/cs/selectAllRoomByWechat", {"wxid": wxid},
                    function (data, textStatus){
                        if (data.resCode == 0) {
                            console.log(allRoomList);
                            allRoomList = data.dataList;
                            initAllChatRoom();
                        } else {
                            console.log("selectAllRoomList" + data.resDesc);
                            //alert(data.resDesc);
                        }
                    } , "json")
        }


    }

    function searchLocalRoom() {
        var keywords = $("#roomSearchInput").val();
        initAllChatRoom(keywords);
    }


    //初始化好友列表
    function initAllChatRoom(keywords) {
        var serviceHtml = '';
        $.each(allRoomList, function (index, fdata) {
            var showName = (fdata.roomName == null ? "" : fdata.roomName ) + "(" + fdata.wxRoomId + ")";
            console.log(showName + "--" + keywords + "--" + (showName.indexOf(keywords) > -1));
            if (!keywords || showName.indexOf(keywords) > -1) {
                var friendHead = fdata.smallHeadPic;
                console.log(fdata);
                friendHead = friendHead ? friendHead : (basePath + "./static/img/defaultHeadPic.jpg");

                var targetClassName = fdata.wxRoomId.replace("@chatroom", "_chatroom");
                serviceHtml += '<li onclick="chooseChatRoom(\''+fdata.wxid+'\', \'' + fdata.wxRoomId+ '\')"  id="'+fdata.wxid + targetClassName+'" data-name="'+fdata.roomName + targetClassName+'">' +
                        '<div class="user_head"><img src="'+friendHead+'"/>';

                serviceHtml+='</div><div class="user_text">\n' +
                        '<p class="user_name">'+showName+'</p>\n' +
                        ' </div>\n' +
                        '  </li>';
            }

        });
        $("#allRoomList").html(serviceHtml);
    }



    function showSendCardDiv() {

        $(".send_card_div").show();
    }


    function sendWxCardMsg() {
        var friendCardWxid = $("#friendCardWxid").val();
        $("#sendCardBtn").attr("disabled", true);
        jQuery.post( "http://47.115.80.88:8082/cs/sendWxCardMsg", {"wxid": selectedWechat, "targetWxid": selectedFriend, "friendWxid": friendCardWxid},
                function (data, textStatus){
                    $("#sendCardBtn").removeAttr("disabled");
                    if (data.resCode == 0) {
                        closeCardDiv();
                        var setMsg = {"nickname": friendCardWxid}
                        showSendMsg(selectedWechat, selectedFriend, 4, 1, JSON.stringify(setMsg));
                    } else {
                        alert(data.resDesc);
                        //alert(data.resDesc);
                    }
                } , "json")
    }

    function closeCardDiv() {
            $(".send_card_div").hide();
    }

</script>

</html>
